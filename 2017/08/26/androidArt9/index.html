<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android开发艺术探索," />










<meta name="description" content="本章讲述Android中的四大组件的工作过程。本章的意义在于加深读者对四大组件的工作方式的认识，由于四大组件的特殊性，我们有必要对它们的工作过程有一定的了解，这也有助于加深对Android整体的体系结构的认识。">
<meta name="keywords" content="Android开发艺术探索">
<meta property="og:type" content="article">
<meta property="og:title" content="Android开发艺术探索笔记-第9章 四大组件的功能">
<meta property="og:url" content="https://luwenjie.me/2017/08/26/androidArt9/index.html">
<meta property="og:site_name" content="逃避可耻但很有用">
<meta property="og:description" content="本章讲述Android中的四大组件的工作过程。本章的意义在于加深读者对四大组件的工作方式的认识，由于四大组件的特殊性，我们有必要对它们的工作过程有一定的了解，这也有助于加深对Android整体的体系结构的认识。">
<meta property="og:image" content="http://wx4.sinaimg.cn/mw690/70396e5agy1firn9lmyi1j20q00txwsv.jpg">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/Activity%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/Service%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/Service%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/%E5%B9%BF%E6%92%AD%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/%E5%B9%BF%E6%92%AD%E7%9A%84%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/ContentProvider_OnCreate.png">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/ContentProvider_Create.png">
<meta property="og:updated_time" content="2017-08-26T02:41:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android开发艺术探索笔记-第9章 四大组件的功能">
<meta name="twitter:description" content="本章讲述Android中的四大组件的工作过程。本章的意义在于加深读者对四大组件的工作方式的认识，由于四大组件的特殊性，我们有必要对它们的工作过程有一定的了解，这也有助于加深对Android整体的体系结构的认识。">
<meta name="twitter:image" content="http://wx4.sinaimg.cn/mw690/70396e5agy1firn9lmyi1j20q00txwsv.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://luwenjie.me/2017/08/26/androidArt9/"/>





  <title>Android开发艺术探索笔记-第9章 四大组件的功能 | 逃避可耻但很有用</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逃避可耻但很有用</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://luwenjie.me/2017/08/26/androidArt9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fromzero">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逃避可耻但很有用">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android开发艺术探索笔记-第9章 四大组件的功能</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-26T10:37:00+08:00">
                2017-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://wx4.sinaimg.cn/mw690/70396e5agy1firn9lmyi1j20q00txwsv.jpg" alt=""></p>
<blockquote>
<p>本章讲述Android中的四大组件的工作过程。本章的意义在于加深读者对四大组件的工作方式的认识，由于四大组件的特殊性，我们有必要对它们的工作过程有一定的了解，这也有助于加深对Android整体的体系结构的认识。</p>
</blockquote>
<a id="more"></a>
<h1 id="四大组件的运行状态"><a href="#四大组件的运行状态" class="headerlink" title="四大组件的运行状态"></a>四大组件的运行状态</h1><p>除了 BroadcastReceiver 以外，其他三种组件都必须在 AndroidManifest.xml 中注册。</p>
<p>Activity 负责前台和用户交互。<br>Service 是一种计算型组件，有 2 种状态：启动状态和绑定状态。<br>BroadcastReceiver 是一种消息型组件，用于在不同的组件和不同应用之间传递消息。<br>ContentProvider 是一种数据共享型组件，用于向其他组件乃至其他应用共享数据。</p>
<h1 id="Activity-的工作过程"><a href="#Activity-的工作过程" class="headerlink" title="Activity 的工作过程"></a>Activity 的工作过程</h1><p><img src="http://7xt4re.com1.z0.glb.clouddn.com/Activity%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>Activity#startActivityForResult<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(</span></span></div><div class="line">          String who, Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options) &#123;</div><div class="line">      Uri referrer = onProvideReferrer();</div><div class="line">      <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">          intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">      &#125;</div><div class="line">      options = transferSpringboardActivityOptions(options);</div><div class="line">      </div><div class="line">      </div><div class="line">      <span class="comment">// 先由 Instrumentation 执行 execStartActivity</span></div><div class="line">      Instrumentation.ActivityResult ar =</div><div class="line">          mInstrumentation.execStartActivity(</div><div class="line">              <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, who,</div><div class="line">              intent, requestCode, options);</div><div class="line">      <span class="comment">// 再由 ActivityThread 执行 sendActivityResult</span></div><div class="line">      <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">          mMainThread.sendActivityResult(</div><div class="line">              mToken, who, requestCode,</div><div class="line">              ar.getResultCode(), ar.getResultData());</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      </div><div class="line">      cancelInputsAndStartExitTransition(options);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>mInstrumentation 在 ActivityThread 的 <code>handleBindApplication()</code> 中初始化完成。在启动 Activity 的时候在 <code>attach()</code> 中传给 Activity。</p>
<p><code>handleBindApplication()</code> 由 ActivityThread$ApplicationThread 的 <code>bindApplication()</code>调用。</p>
<p>Instrumentation#execStartActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">    Context who, IBinder contextThread, IBinder token, String target,</div><div class="line">    Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="comment">// 真正启动 Activity 的是 ActivityManagerNative.getDefault</span></div><div class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">                    </div><div class="line">        <span class="comment">// 检查 Activity 启动的结果，抛出一些异常</span></div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看一下 <code>ActivityManagerNative</code>,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div></pre></td></tr></table></figure>
<p>ActivityManagerService 继承自 ActivityManagerNative<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">ActivityManagerNative</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span></div></pre></td></tr></table></figure></p>
<p>这个方法返回的是 AMS(ActivityManagerService)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the system's default/global activity manager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>gDefault 是一个 Singleton 单例对象，第一次创建时调用 <code>create()</code> 创建出 AMS。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">            &#125;</div><div class="line">            IActivityManager am = asInterface(b);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> am;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure></p>
<h2 id="AMS-和-ActivityStack-互相调用"><a href="#AMS-和-ActivityStack-互相调用" class="headerlink" title="AMS 和 ActivityStack 互相调用"></a>AMS 和 ActivityStack 互相调用</h2><p>现在 startActivity 的执行过程走到了 AMS 里面。  </p>
<p>AMS 中的 <code>startActivity()</code> 内部的调用逻辑顺序。</p>
<ol>
<li><code>startActivity()</code></li>
<li><code>startActivityAsUser()</code></li>
<li><code>startActivityMayWait()</code></li>
<li><code>startActivityLocked()</code></li>
<li><code>startActivityUnchecked()</code></li>
<li><code>resumeTargetStackIfNeeded()</code></li>
<li>ActivityStackSupervisor#<code>resumeFocusedStackTopActivityLocked()</code></li>
<li>ActivityStack#<code>resumeTopActivityUncheckedLocked()</code></li>
<li>ActivityStack#<code>resumeTopActivityInnerLocked()</code></li>
<li>ActivityStackSupervisor#<code>startSpecificActivityLocked()</code></li>
<li>ActivityStackSupervisor#<code>realStartActivityLocked()</code></li>
</ol>
<p>最终会走到 <code>realStartActivityLocked()</code><br>com.android.server.am.ActivityStackSupervisor#realStartActivityLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></div><div class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// ...</span></div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="comment">// 这里才是真正启动了 Activity 的地方。</span></div><div class="line">        <span class="comment">// app.thread 是 IApplicationThread</span></div><div class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</div><div class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</div><div class="line">                <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div><div class="line"></div><div class="line">        <span class="comment">// ...</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="IApplicationThread-及它的实现者"><a href="#IApplicationThread-及它的实现者" class="headerlink" title="IApplicationThread 及它的实现者"></a>IApplicationThread 及它的实现者</h2><p>IApplicationThread 是一个 Binder 类型的接口，内部包含大量启动和停止 Activity 以及 Service 的接口。</p>
<p>不难猜测，IApplicationThread 的实现者完成了大量和 Activity 以及 Service 启动/停止相关的功能。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IApplicationThread</span> <span class="keyword">extends</span> <span class="title">IInterface</span></span></div></pre></td></tr></table></figure></p>
<p>IApplicationThread 的实现者是 ActivityThread 的内部类 ApplicationThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span></span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThreadNative</span> <span class="keyword">extends</span> <span class="title">Binder</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">IApplicationThread</span></div></pre></td></tr></table></figure>
<p>ApplicationThreadNative 的作用其实和系统为 AIDL 文件生成的类是一样的。  </p>
<p>ApplicationThreadNative 就是 IApplicationThread 的实现者，由于 ApplicationThreadNative 被系统定义为抽象类，所以 ApplicationThread 就成了 IApplicationThread 最终的实现者。    </p>
<hr>
<p>android.app.ActivityThread$ApplicationThread#scheduleLaunchActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></div><div class="line">               ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">               CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">               <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</div><div class="line">               List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">               <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo) &#123;</div><div class="line"></div><div class="line">           <span class="comment">// ....</span></div><div class="line">           sendMessage(H.LAUNCH_ACTIVITY, r);</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(</div><div class="line">          TAG, <span class="string">"SCHEDULE "</span> + what + <span class="string">" "</span> + mH.codeToString(what)</div><div class="line">          + <span class="string">": "</span> + arg1 + <span class="string">" / "</span> + obj);</div><div class="line">      Message msg = Message.obtain();</div><div class="line">      msg.what = what;</div><div class="line">      msg.obj = obj;</div><div class="line">      msg.arg1 = arg1;</div><div class="line">      msg.arg2 = arg2;</div><div class="line">      <span class="keyword">if</span> (async) &#123;</div><div class="line">          msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">      &#125;</div><div class="line">      mH.sendMessage(msg);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>最终使用 mH 发送一条 msg 通知启动 Activity。  </p>
<p>mH 是一个名为 H 的 Handler。  </p>
<p>H 处理启动 Activity 的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</div><div class="line">    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line"></div><div class="line">    r.packageInfo = getPackageInfoNoCheck(</div><div class="line">    r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">    handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="启动-Activity-的具体细节"><a href="#启动-Activity-的具体细节" class="headerlink" title="启动 Activity 的具体细节"></a>启动 Activity 的具体细节</h2><p>这里又走到了 ActivityThread#handleLaunchActivity()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <span class="comment">// Initialize before creating the activity</span></div><div class="line">        WindowManagerGlobal.initialize();</div><div class="line">        </div><div class="line">        <span class="comment">// 由 performLaunchActivity 创建出了 Activity 对象    </span></div><div class="line">        Activity a = performLaunchActivity(r, customIntent);</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">            <span class="comment">// 执行 resume 状态</span></div><div class="line">            handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</div><div class="line">            </div><div class="line">            <span class="comment">// 判断 pause</span></div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">                performPauseActivityIfNeeded(r, reason);</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</div><div class="line">                    r.state = oldState;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// finish Activity</span></div><div class="line">                ActivityManagerNative.getDefault()</div><div class="line">                    .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</div><div class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<hr>
<p>performLaunchActivity 主要做了 5 件事：</p>
<ol>
<li>从 ActivityClientRecord 中获取待启动的 Activity 的组件信息</li>
<li>通过 Instrumentation 的 newActivity 方法使用类加载器创建 Activity 对象</li>
<li>通过 LoadedApk 的 makeApplication 方法来尝试创建 Application 对象</li>
<li>创建 ContextImpl 对象并通过 Activity 的 attach 方法来完成一些重要数据的初始化</li>
<li>调用 Activity 的 onCreate 方法</li>
</ol>
<hr>
<p>ActivityThread#performLaunchActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 1. 从 ActivityClientRecord 中获取待启动的 Activity 的组件信息</span></div><div class="line">    ActivityInfo aInfo = r.activityInfo;</div><div class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                Context.CONTEXT_INCLUDE_CODE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ComponentName component = r.intent.getComponent();</div><div class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">        component = r.intent.resolveActivity(</div><div class="line">            mInitialApplication.getPackageManager());</div><div class="line">        r.intent.setComponent(component);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</div><div class="line">                r.activityInfo.targetActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 2. 通过 Instrumentation 的 newActivity 方法使用类加载器创建 Activity 对象</span></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">        activity = mInstrumentation.newActivity(</div><div class="line">                cl, component.getClassName(), r.intent);</div><div class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">        r.intent.setExtrasClassLoader(cl);</div><div class="line">        r.intent.prepareToEnterProcess();</div><div class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">            r.state.setClassLoader(cl);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to instantiate activity "</span> + component</div><div class="line">                + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//3. 通过LoadedApk的makeApplication方法来尝试创建Application对象</span></div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">     </div><div class="line">        <span class="comment">// ...   </span></div><div class="line">        </div><div class="line">        <span class="comment">// 4. 创建ContextImpl对象并通过Activity的attach方法来完成一些重要数据的初始化</span></div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            </div><div class="line">            <span class="comment">// ContextImpl 通过 Activty 的 attach 和 Activity 建立关联</span></div><div class="line">            <span class="comment">// 在 attach 中 Activity 会完成 Window 的创建并和 Window 关联，</span></div><div class="line">            <span class="comment">// 这样 Window 接收到外部输入事件后就可以将事件传递给 Activity</span></div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor, window);</div><div class="line"></div><div class="line">            <span class="comment">// ...</span></div><div class="line">            </div><div class="line">            <span class="comment">// 5. 调用 Activity 的 onCreate 方法,</span></div><div class="line">            <span class="comment">// 此时完成了 Activity 的启动</span></div><div class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">           <span class="comment">// ...</span></div><div class="line">          </div><div class="line">        mActivities.put(r.token, r);</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>newActivity()</code>就是通过类加载器创建 Activity 对象  </p>
<p>android.app.Instrumentation#newActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(Class&lt;?&gt; clazz, Context context, </span></span></div><div class="line">        IBinder token, Application application, Intent intent, ActivityInfo info, </div><div class="line">        CharSequence title, Activity parent, String id,</div><div class="line">        Object lastNonConfigurationInstance) <span class="keyword">throws</span> InstantiationException, </div><div class="line">        IllegalAccessException &#123;</div><div class="line">    Activity activity = (Activity)clazz.newInstance();</div><div class="line">    ActivityThread aThread = <span class="keyword">null</span>;</div><div class="line">    activity.attach(context, aThread, <span class="keyword">this</span>, token, <span class="number">0</span>, application, intent,</div><div class="line">            info, title, parent, id,</div><div class="line">            (Activity.NonConfigurationInstances)lastNonConfigurationInstance,</div><div class="line">            <span class="keyword">new</span> Configuration(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>android.app.LoadedApk#makeApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></div><div class="line">           Instrumentation instrumentation) &#123;</div><div class="line">       <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// 一个 app 只能有一个 Application</span></div><div class="line">           <span class="keyword">return</span> mApplication;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"makeApplication"</span>);</div><div class="line"></div><div class="line">       Application app = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       String appClass = mApplicationInfo.className;</div><div class="line">       <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</div><div class="line">           appClass = <span class="string">"android.app.Application"</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           java.lang.ClassLoader cl = getClassLoader();</div><div class="line">           <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</div><div class="line">               initializeJavaContextClassLoader();</div><div class="line">           &#125;</div><div class="line">           ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</div><div class="line">           <span class="comment">// 通过 Instrumentation 的 newApplication创建对象。也是用类加载器加载的。</span></div><div class="line">           app = mActivityThread.mInstrumentation.newApplication(</div><div class="line">                   cl, appClass, appContext);</div><div class="line">           appContext.setOuterContext(app);</div><div class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">           <span class="comment">// ...</span></div><div class="line">       &#125;</div><div class="line">       mActivityThread.mAllApplications.add(app);</div><div class="line">       mApplication = app;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (instrumentation != <span class="keyword">null</span>) &#123;</div><div class="line">           instrumentation.callApplicationOnCreate(app);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Rewrite the R 'constants' for all library apks.</span></div><div class="line">       SparseArray&lt;String&gt; packageIdentifiers = getAssets(mActivityThread)</div><div class="line">               .getAssignedPackageIdentifiers();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> N = packageIdentifiers.size();</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> id = packageIdentifiers.keyAt(i);</div><div class="line">           <span class="keyword">if</span> (id == <span class="number">0x01</span> || id == <span class="number">0x7f</span>) &#123;</div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> app;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h1 id="Service-的工作过程"><a href="#Service-的工作过程" class="headerlink" title="Service 的工作过程"></a>Service 的工作过程</h1><p>Service 分为两种工作状态：</p>
<ol>
<li>启动状态，主要用于执行后台计算</li>
<li>绑定状态，主要用于其他组件和 Service 的交互</li>
</ol>
<p>这两种状态可以共存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Intent intentService = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,MyService.class);</div><div class="line"><span class="comment">// 启动</span></div><div class="line">startService(intentService);</div><div class="line"><span class="comment">// 绑定</span></div><div class="line">bindService(intentService,mServiceConnection,BIND_AUTO_CREATE);</div></pre></td></tr></table></figure>
<h2 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h2><p><img src="http://7xt4re.com1.z0.glb.clouddn.com/Service%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>从 ContextWrapper 的 startService 开始。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mBase.startService(service);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Activity 创建的时候会通过 <code>attach()</code> 将一个 ContextImpl 对象关联起来，这个 ContextImpl 对象就是上面的 <code>mBase</code>。  </p>
<p>ContextWrapper 的大部分实现都是由 mBase 实现。这是桥接模式。</p>
<p>ContextImpl 中 <code>startService()</code> 的最终实现时 <code>startServiceCommon()</code>:</p>
<p>android.app.ContextImpl#startServiceCommon<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, UserHandle user)</span> </span>&#123;</div><div class="line">     </div><div class="line">     validateServiceIntent(service);</div><div class="line">     service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">     </div><div class="line">     <span class="comment">// 这里通过 AMS 远程调用 startService </span></div><div class="line">     ComponentName cn = ActivityManagerNative.getDefault().startService(</div><div class="line">             mMainThread.getApplicationThread(),</div><div class="line">             service,service.resolveTypeIfNeeded(getContentResolver()), getOpPackageName(),</div><div class="line">             user.getIdentifier());</div><div class="line">         <span class="comment">// ....</span></div><div class="line">         <span class="keyword">return</span> cn;</div><div class="line">     </div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>com.android.server.am.ActivityManagerService#startService<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></div><div class="line">        String resolvedType, String callingPackage, <span class="keyword">int</span> userId)</div><div class="line">        <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"startService"</span>);</div><div class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">   <span class="comment">// ...</span></div><div class="line"></div><div class="line"> </div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">        <span class="comment">// mServices 是 ActiveService，辅助 AMS 管理 Service.</span></div><div class="line">        ComponentName res = mServices.startServiceLocked(caller, service,</div><div class="line">                resolvedType, callingPid, callingUid, callingPackage, userId);</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 AMS 的 <code>startService()</code> 内部的调用链。</p>
<ol>
<li>ActiveService#<code>startServiceLocked()</code></li>
<li>ActiveService#<code>startServiceInnerLocked()</code></li>
<li>ActiveService#<code>bringUpServiceLocked()</code></li>
<li>ActiveService#<code>sendServiceArgsLocked()</code></li>
<li>ActiveService#<code>realStartServiceLocked()</code></li>
</ol>
<hr>
<p>com.android.server.am.ActiveService#startServiceInnerLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ServiceRecord 描述的是一个 Service 记录，它贯穿整个 Service 的启动过程。</span></div><div class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></div><div class="line">            <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">        ServiceState stracker = r.getTracker();</div><div class="line">        <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</div><div class="line">            stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</div><div class="line">        &#125;</div><div class="line">        r.callStart = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">            r.stats.startRunningLocked();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 将具体的启动工作交给了 bringUpServiceLocked</span></div><div class="line">        String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</div><div class="line">            <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</div><div class="line">            smap.mStartingBackground.add(r);</div><div class="line">            r.startingBgTimeout = SystemClock.uptimeMillis() + BG_START_TIMEOUT;</div><div class="line">            <span class="comment">// ... </span></div><div class="line">            <span class="keyword">if</span> (first) &#123;</div><div class="line">                smap.rescheduleDelayedStarts();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg) &#123;</div><div class="line">            smap.ensureNotStartingBackground(r);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> r.name;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>com.android.server.am.ActiveService#realStartServiceLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></div><div class="line">            ProcessRecord app, <span class="keyword">boolean</span> execInFg) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">       </div><div class="line">       <span class="comment">// ... </span></div><div class="line">        r.app = app;</div><div class="line">        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</div><div class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</div><div class="line">        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        mAm.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ... </span></div><div class="line">            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">                r.stats.startLaunchedLocked();</div><div class="line">            &#125;</div><div class="line">            mAm.notifyPackageUse(r.serviceInfo.packageName,</div><div class="line">                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</div><div class="line">            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            </div><div class="line">            </div><div class="line">            </div><div class="line">            </div><div class="line">            </div><div class="line">            <span class="comment">// 通过 ActivityThread 的 scheduleCreateService 创建 Service 对象</span></div><div class="line">            app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                    app.repProcState);</div><div class="line">            r.postNotification();</div><div class="line">            created = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.whitelistManager) &#123;</div><div class="line">            app.whitelistManager = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        requestServiceBindingsLocked(r, execInFg);</div><div class="line"></div><div class="line">        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If the service is in the started state, and there are no</span></div><div class="line">        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></div><div class="line">        <span class="comment">// be called.</span></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</div><div class="line">            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>));</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 调用 Service 的其他方法。比如 onStartCommand.    </span></div><div class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">       <span class="comment">// ...</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>和 Activity 一样通过 Handler 发送 msg。  </p>
<p>ActivityThread#scheduleCreateService<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></div><div class="line">        ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState) &#123;</div><div class="line">    updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">    CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</div><div class="line">    s.token = token;</div><div class="line">    s.info = info;</div><div class="line">    s.compatInfo = compatInfo;</div><div class="line"></div><div class="line">    sendMessage(H.CREATE_SERVICE, s);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ActivityThread#handleCreateService<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</div><div class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">    <span class="comment">// we are back active so skip it.</span></div><div class="line">    unscheduleGcIdler();</div><div class="line"></div><div class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</div><div class="line">            data.info.applicationInfo, data.compatInfo);</div><div class="line">    Service service = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 通过类加载器创建 Service 的实例</span></div><div class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</div><div class="line">        service = (Service) cl.loadClass(data.info.name).newInstance();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       <span class="comment">// ... </span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      </div><div class="line">        </div><div class="line">        <span class="comment">// 创建 ContextImpl 对象</span></div><div class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</div><div class="line">        context.setOuterContext(service);</div><div class="line">        <span class="comment">// 创建 Application</span></div><div class="line">        Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line">        <span class="comment">// 通过 attach 将 Service 对象和 ContextImpl 对象关联。</span></div><div class="line">        service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</div><div class="line">                ActivityManagerNative.getDefault());</div><div class="line">        <span class="comment">// 调用 service 的 onCreate</span></div><div class="line">        service.onCreate();</div><div class="line">        </div><div class="line">        <span class="comment">// 将 service 存入集合中</span></div><div class="line">        mServices.put(data.token, service);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                    data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除此之外 ActivieService#<code>sendServiceArgsLocked()</code> 内部会调用 ActivityThread 的 <code>scheduleServiceArgs()</code>, 最终调用 <code>handleServiceArgs()</code></p>
<p>android.app.ActivityThread#handleServiceArgs<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</div><div class="line">        Service s = mServices.get(data.token);</div><div class="line">       </div><div class="line">        <span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</div><div class="line">            data.args.setExtrasClassLoader(s.getClassLoader());</div><div class="line">                    data.args.prepareToEnterProcess();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> res;</div><div class="line">        <span class="keyword">if</span> (!data.taskRemoved) &#123;</div><div class="line">            <span class="comment">// 调用了 service 的 onStartCommand()</span></div><div class="line">            res = s.onStartCommand(data.args, data.flags, data.startId);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            s.onTaskRemoved(data.args);</div><div class="line">            res = Service.START_TASK_REMOVED_COMPLETE;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        QueuedWork.waitToFinish();</div><div class="line"></div><div class="line">                </div><div class="line">        ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                            data.token,</div><div class="line">                            SERVICE_DONE_EXECUTING_START,</div><div class="line">                            data.startId, res);</div><div class="line">        ensureJitEnabled();</div><div class="line">            </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Service-的绑定过程"><a href="#Service-的绑定过程" class="headerlink" title="Service 的绑定过程"></a>Service 的绑定过程</h2><p>和启动过程一样是从 ContextImpl 中的 <code>bindServiceCommon()</code> 开始。 </p>
<p><img src="http://7xt4re.com1.z0.glb.clouddn.com/Service%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>ContextImpl#bindServiceCommon<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler</span></span></div><div class="line">        handler, UserHandle user) &#123;</div><div class="line">    IServiceConnection sd;</div><div class="line">   </div><div class="line">    <span class="comment">// 将客户端的 ServiceConnection 对象转成 ServiceDispatcher.InnerConnection。</span></div><div class="line">    <span class="comment">// 因为服务的绑定有可能是跨进程的，ServiceConnection 对象必须借助于</span></div><div class="line">    <span class="comment">// Binder 才能让远程服务回调自己的方法。</span></div><div class="line">    sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</div><div class="line"></div><div class="line">    </div><div class="line">    IBinder token = getActivityToken();</div><div class="line">    <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></div><div class="line">                &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">        flags |= BIND_WAIVE_PRIORITY;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 调用 AMS 的 bindService</span></div><div class="line">    <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">            service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">            sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">    <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>android.app.LoadedApk#getServiceDispatcher<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span><span class="params">(ServiceConnection c,</span></span></div><div class="line">        Context context, Handler handler, <span class="keyword">int</span> flags) &#123;</div><div class="line">    <span class="comment">// mService 是一个 map    </span></div><div class="line">    <span class="keyword">synchronized</span> (mServices) &#123;</div><div class="line">        <span class="comment">// 一顿操作，map 有的话从 map 取，没有就创建存进去。</span></div><div class="line">        LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</div><div class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            sd = map.get(c);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sd == <span class="keyword">null</span>) &#123;</div><div class="line">            sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</div><div class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">                map = <span class="keyword">new</span> ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;();</div><div class="line">                mServices.put(context, map);</div><div class="line">            &#125;</div><div class="line">            map.put(c, sd);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            </div><div class="line">            sd.validate(context, handler);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 返回内部保寸的 IServiceConnection 对象</span></div><div class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ActivityManagerService#bindService<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line">        String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</div><div class="line">        <span class="keyword">int</span> userId) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</div><div class="line">                resolvedType, connection, flags, callingPackage, userId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AMS 的调用过程：</p>
<ol>
<li>bindService()</li>
<li>ActiveServices#bindServiceLocked()</li>
<li>ActiveServices#bringUpServiceLocked()</li>
<li>ActiveServices#realStartServiceLocked()</li>
<li>ActiveServices#requestServiceBindingsLocked()</li>
<li>ActiveServices#requestServiceBindingLocked()</li>
<li>ActivityThread$ApplicationThread#scheduleBindService()</li>
</ol>
<p>接着和启动过程类似。都是最终调用 ActivityThread 来创建 Service 实例并执行 <code>onCreate()</code>。</p>
<p>Service 的绑定过程会调用 ActiveServices 的 <code>requestServiceBindingsLocked()</code>。最终调用 ActivityThread$ApplicationThread 的 <code>scheduleBindService()</code>。然后通过 H 这个 Handler 转向 ActivityThread 的 <code>handleBindService()</code></p>
<p>ActivityThread#handleBindService()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</div><div class="line">       Service s = mServices.get(data.token);</div><div class="line">    </div><div class="line">         </div><div class="line">       data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">       data.intent.prepareToEnterProcess();</div><div class="line">      </div><div class="line">       <span class="keyword">if</span> (!data.rebind) &#123;</div><div class="line">           <span class="comment">// 调用 Service 的 onBind 方法</span></div><div class="line">           IBinder binder = s.onBind(data.intent);</div><div class="line">           <span class="comment">// 调用 AMS 的 publishService。通知客户端已经成功连接</span></div><div class="line">           ActivityManagerNative.getDefault().publishService(</div><div class="line">                               data.token, data.intent, binder);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// 调用 Service 的 onReBind 方法</span></div><div class="line">           s.onRebind(data.intent);</div><div class="line">           ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                               data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line">       ensureJitEnabled();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="通知客户端绑定成功"><a href="#通知客户端绑定成功" class="headerlink" title="通知客户端绑定成功"></a>通知客户端绑定成功</h3><p>AMS 的 <code>publishService()</code> 调用了 ActiveServices#publishServiceLocked()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">    Intent.FilterComparison filter</div><div class="line">                    = <span class="keyword">new</span> Intent.FilterComparison(intent);</div><div class="line">    IntentBindRecord b = r.bindings.get(filter);</div><div class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; !b.received) &#123;</div><div class="line">        b.binder = service;</div><div class="line">        b.requested = <span class="keyword">true</span>;</div><div class="line">        b.received = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</div><div class="line">            ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</div><div class="line">                ConnectionRecord c = clist.get(i);</div><div class="line">            </div><div class="line">                <span class="comment">// c 是 ConnectionRecord</span></div><div class="line">                <span class="comment">// conn 是 LoadedApk.ServiceDispatcher.InnerConnection</span></div><div class="line">                <span class="comment">// service 是 Service 的 onBind() 返回的 Binder</span></div><div class="line">                c.conn.connected(r.name, service);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看看 InnerConnection 这个类：</p>
<p>LoadedApk.ServiceDispatcher.InnerConnection<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">           <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</div><div class="line"></div><div class="line">           InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</div><div class="line">               mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">               LoadedApk.ServiceDispatcher sd = mDispatcher.get();</div><div class="line">               <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">// 调用了 ServiceDispatcher 的 connected</span></div><div class="line">                   sd.connected(name, service);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>LoadedApk.ServiceDispatcher#connected<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// mActivityThread 是 ActivityThread 中的 H，不会为空</span></div><div class="line">        <span class="comment">// 所以 RunConnection 会运行在主线程中，所以客户端</span></div><div class="line">        <span class="comment">// ServiceConnection 中的方法是在主线程中被回调的。</span></div><div class="line">        <span class="comment">// RunConnection 内部也是调用了 doConnected</span></div><div class="line">        mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        doConnected(name, service);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LoadedApk.ServiceDispatcher#doConnected</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">    ServiceDispatcher.ConnectionInfo old;</div><div class="line">    ServiceDispatcher.ConnectionInfo info;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      </div><div class="line">        old = mActiveConnections.get(name);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old.binder == service) &#123;</div><div class="line">            <span class="comment">// Huh, already have this one.  Oh well!</span></div><div class="line">            <span class="comment">// 绑定的和之前的一样就直接 return</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 新的 service 连接了</span></div><div class="line">            <span class="comment">// A new service is being connected... set it all up.</span></div><div class="line">            info = <span class="keyword">new</span> ConnectionInfo();</div><div class="line">            info.binder = service;</div><div class="line">            info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</div><div class="line">          </div><div class="line">            service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</div><div class="line">            mActiveConnections.put(name, info);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// The named service is being disconnected... clean up.</span></div><div class="line">            mActiveConnections.remove(name);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">            old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// If there was an old service, it is now disconnected.</span></div><div class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 将老的断开</span></div><div class="line">        mConnection.onServiceDisconnected(name);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// If there is a new service, it is now connected.</span></div><div class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 新的连接</span></div><div class="line">        mConnection.onServiceConnected(name, service);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以绑定只会绑定一次。  </p>
<p>停止过程和解除绑定的过程，系统的执行过程是类似的。  </p>
<h1 id="BroadcastReceiver-的工作过程"><a href="#BroadcastReceiver-的工作过程" class="headerlink" title="BroadcastReceiver 的工作过程"></a>BroadcastReceiver 的工作过程</h1><p>主要包含：</p>
<ol>
<li>广播的注册过程</li>
<li>广播的发送和接收过程</li>
</ol>
<p>定义广播：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line">  <span class="comment">// 此处不可以做耗时操作。参考值：10s以内</span></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line"></div><div class="line">    String action = intent.getAction();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注册广播：</p>
<ol>
<li><p>静态注册</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".MyBroadcastReceiver"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"me.luwenjie.chapter9.receiver"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>动态注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">filter.addAction(<span class="string">"me.luwenjie.chapter9.receiver"</span>);</div><div class="line">registerReceiver(<span class="keyword">new</span> MyBroadcastReceiver(),filter);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>发送广播<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Intent intent =  <span class="keyword">new</span> Intent(<span class="string">"me.luwenjie.chapter9.receiver"</span>);</div><div class="line">sendBroadcast(intent);</div></pre></td></tr></table></figure></p>
<h2 id="注册过程"><a href="#注册过程" class="headerlink" title="注册过程"></a>注册过程</h2><p>静态注册的广播在应用安装时由系统自动完成注册，由 PMS（PackageManagerServcie）来完成整个注册过程。  </p>
<p>动态注册从 ContextWrapper 的 <code>registerReceiver()</code> 开始。内部由 ContextImpl 实现。</p>
<p>调用链：</p>
<p><img src="http://7xt4re.com1.z0.glb.clouddn.com/%E5%B9%BF%E6%92%AD%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="keyword">int</span> userId,</span></span></div><div class="line">           IntentFilter filter, String broadcastPermission,</div><div class="line">           Handler scheduler, Context context) &#123;</div><div class="line">       IIntentReceiver rd = <span class="keyword">null</span>;</div><div class="line">       </div><div class="line">           <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</div><div class="line">                   scheduler = mMainThread.getHandler();</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// 从 mPackageInfo 获取 IIntentReceiver 对象</span></div><div class="line">               <span class="comment">// 这是一个 IPC，BroadcastReceiver 作为 Android</span></div><div class="line">               <span class="comment">// 一个组件是不能直接跨进程传递的，需要通过 IIntentReceiver </span></div><div class="line">               <span class="comment">// 中转。IIntentReceiver 是一个 Binder 接口。</span></div><div class="line">               rd = mPackageInfo.getReceiverDispatcher(</div><div class="line">                   receiver, context, scheduler,</div><div class="line">                   mMainThread.getInstrumentation(), <span class="keyword">true</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</div><div class="line">                   scheduler = mMainThread.getHandler();</div><div class="line">               &#125;</div><div class="line">               rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</div><div class="line">                       receiver, context, scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</div><div class="line">           &#125;</div><div class="line">       </div><div class="line">       </div><div class="line">           <span class="keyword">final</span> Intent intent = ActivityManagerNative.getDefault().registerReceiver(</div><div class="line">                   mMainThread.getApplicationThread(), mBasePackageName,</div><div class="line">                   rd, filter, broadcastPermission, userId);</div><div class="line">           <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">               intent.setExtrasClassLoader(getClassLoader());</div><div class="line">               intent.prepareToEnterProcess();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> intent;</div><div class="line">       </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>LoadedApk#getReceiverDispatcher<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">getReceiverDispatcher</span><span class="params">(BroadcastReceiver r,</span></span></div><div class="line">        Context context, Handler handler,</div><div class="line">        Instrumentation instrumentation, <span class="keyword">boolean</span> registered) &#123;</div><div class="line">    <span class="keyword">synchronized</span> (mReceivers) &#123;</div><div class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</div><div class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map = <span class="keyword">null</span>;</div><div class="line">        </div><div class="line">        <span class="comment">// 已注册就从存储中查找</span></div><div class="line">        <span class="keyword">if</span> (registered) &#123;</div><div class="line">            map = mReceivers.get(context);</div><div class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">                rd = map.get(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 否则新建存储</span></div><div class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</div><div class="line">            rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</div><div class="line">                    instrumentation, registered);</div><div class="line">            <span class="keyword">if</span> (registered) &#123;</div><div class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">                    map = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;();</div><div class="line">                    mReceivers.put(context, map);</div><div class="line">                &#125;</div><div class="line">                map.put(r, rd);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            rd.validate(context, handler);</div><div class="line">        &#125;</div><div class="line">        rd.mForgotten = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> rd.getIIntentReceiver();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>AMS#registerReceiver </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage,</span></span></div><div class="line">        IIntentReceiver receiver, IntentFilter filter, String permission, <span class="keyword">int</span> userId) &#123;</div><div class="line">   </div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"> </div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        ReceiverList rl = mRegisteredReceivers.get(receiver.asBinder());</div><div class="line">        <span class="keyword">if</span> (rl == <span class="keyword">null</span>) &#123;</div><div class="line">            rl = <span class="keyword">new</span> ReceiverList(<span class="keyword">this</span>, callerApp, callingPid, callingUid,</div><div class="line">                    userId, receiver);</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            <span class="comment">// 将远程的 IIntentReceiver 对象存储</span></div><div class="line">            mRegisteredReceivers.put(receiver.asBinder(), rl);</div><div class="line">        &#125; </div><div class="line">        <span class="comment">// ... </span></div><div class="line">        </div><div class="line">        </div><div class="line">        BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, callerPackage,</div><div class="line">                permission, callingUid, userId);</div><div class="line">        rl.add(bf);</div><div class="line">        <span class="comment">// 将 IntentFilter 对象存储</span></div><div class="line">        mReceiverResolver.addFilter(bf);</div><div class="line"></div><div class="line">        <span class="comment">// ...</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> sticky;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="发送和接收过程"><a href="#发送和接收过程" class="headerlink" title="发送和接收过程"></a>发送和接收过程</h2><p><img src="http://7xt4re.com1.z0.glb.clouddn.com/%E5%B9%BF%E6%92%AD%E7%9A%84%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B.png" alt=""></p>
<p>ContextImpl#sendBroadcast<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    String resolvedType = intent.resolveTypeIfNeeded(getContentResolver());</div><div class="line"> </div><div class="line">        intent.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">        ActivityManagerNative.getDefault().broadcastIntent(</div><div class="line">                mMainThread.getApplicationThread(), intent, resolvedType, <span class="keyword">null</span>,</div><div class="line">                Activity.RESULT_OK, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">                getUserId());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AMS 内部最终调用了 <code>broadcastIntentLocked()</code> </p>
<p>系统从 Android 3.1 开始为 Intent 添加了 2 个标记：</p>
<ol>
<li>FLAG_INCLUDE_STOPPED_PACKAGES  <blockquote>
<p>包含已经停止的应用，广播会发送给已经停止的应用</p>
</blockquote>
</li>
<li>FLAG_EXCLUDE_STOPPED_PACKAGES  <blockquote>
<p>不包含已经停止的应用，广播不会发送给已经停止的应用  </p>
</blockquote>
</li>
</ol>
<p>系统为所有广播默认添加了 <code>FLAG_EXCLUDE_STOPPED_PACKAGES</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">broadcastIntentLocked</span><span class="params">(ProcessRecord callerApp,</span></span></div><div class="line">        String callerPackage, Intent intent, String resolvedType,</div><div class="line">        IIntentReceiver resultTo, <span class="keyword">int</span> resultCode, String resultData,</div><div class="line">        Bundle resultExtras, String[] requiredPermissions, <span class="keyword">int</span> appOp, Bundle bOptions,</div><div class="line">        <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId) &#123;</div><div class="line">    intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">    <span class="comment">// By default broadcasts do not go to stopped apps.</span></div><div class="line">    <span class="comment">// 默认情况下，广播不会发送给已经停止的应用</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    intent.addFlags(Intent.FLAG_EXCLUDE_STOPPED_PACKAGES);</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="comment">// 根据 intentFilter 查找出匹配的广播接收者并经过一系列的条件过滤。</span></div><div class="line">    <span class="comment">// 最终将满足条件的广播接收者添加到 BroadcastQueue 中，BroadcastQueue</span></div><div class="line">    <span class="comment">// 就会将广播发送给相应的广播接收者。</span></div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// ... </span></div><div class="line"> </div><div class="line">      </div><div class="line">    <span class="keyword">if</span> ((receivers != <span class="keyword">null</span> &amp;&amp; receivers.size() &gt; <span class="number">0</span>)</div><div class="line">            || resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">        BroadcastQueue queue = broadcastQueueForIntent(intent);</div><div class="line">        BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</div><div class="line">                callerPackage, callingPid, callingUid, resolvedType,</div><div class="line">                requiredPermissions, appOp, brOptions, receivers, resultTo, resultCode,</div><div class="line">                resultData, resultExtras, ordered, sticky, <span class="keyword">false</span>, userId);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> replaced = replacePending &amp;&amp; queue.replaceOrderedBroadcastLocked(r);</div><div class="line">        <span class="keyword">if</span> (!replaced) &#123;</div><div class="line">            queue.enqueueOrderedBroadcastLocked(r);</div><div class="line">            <span class="comment">// 将广播发送给相应的接收者</span></div><div class="line">            queue.scheduleBroadcastsLocked();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// There was nobody interested in the broadcast, but we still want to record</span></div><div class="line">        <span class="comment">// that it happened.</span></div><div class="line">        <span class="keyword">if</span> (intent.getComponent() == <span class="keyword">null</span> &amp;&amp; intent.getPackage() == <span class="keyword">null</span></div><div class="line">                &amp;&amp; (intent.getFlags()&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// This was an implicit broadcast... let's record it for posterity.</span></div><div class="line">            addBroadcastStatLocked(intent.getAction(), callerPackage, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ActivityManager.BROADCAST_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> com.android.server.am.BroadcastQueue#scheduleBroadcastsLocked<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleBroadcastsLocked</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mBroadcastsScheduled) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 给内部的 Handler 发送了一条 msg。该 Handler 运行在主线程</span></div><div class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="keyword">this</span>));</div><div class="line">    mBroadcastsScheduled = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> com.android.server.am.BroadcastQueue#processNextBroadcast</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(mService) &#123;</div><div class="line">        BroadcastRecord r;</div><div class="line"></div><div class="line">        </div><div class="line">        mService.updateCpuStats();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fromMsg) &#123;</div><div class="line">            mBroadcastsScheduled = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// First, deliver any non-serialized broadcasts right away.</span></div><div class="line">        <span class="comment">// 先分发无序广播。无序广播存储在 mParallelBroadcasts 中。</span></div><div class="line">        <span class="keyword">while</span> (mParallelBroadcasts.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            r = mParallelBroadcasts.remove(<span class="number">0</span>);</div><div class="line">            r.dispatchTime = SystemClock.uptimeMillis();</div><div class="line">            r.dispatchClockTime = System.currentTimeMillis();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = r.receivers.size();</div><div class="line">            <span class="comment">// 遍历</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                Object target = r.receivers.get(i);</div><div class="line">                <span class="comment">// 分发广播</span></div><div class="line">                deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, <span class="keyword">false</span>, i);</div><div class="line">            &#125;</div><div class="line">            addBroadcastToHistoryLocked(r);</div><div class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST_LIGHT) Slog.v(TAG_BROADCAST, <span class="string">"Done with parallel broadcast ["</span></div><div class="line">                    + mQueueName + <span class="string">"] "</span> + r);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="comment">// ....</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终调用  </p>
<p>LoadedApk$ReceiverDispatcher#performReceive<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String data,</span></span></div><div class="line">            Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser) &#123;</div><div class="line">            </div><div class="line">        <span class="comment">// 新建 Args 对象</span></div><div class="line">        <span class="keyword">final</span> Args args = <span class="keyword">new</span> Args(intent, resultCode, data, extras, ordered,</div><div class="line">                sticky, sendingUser);</div><div class="line">         <span class="comment">// ...</span></div><div class="line">         </div><div class="line">         <span class="comment">// 通过 ActivityThread 中的 H 执行 args 中的逻辑</span></div><div class="line">        <span class="keyword">if</span> (intent == <span class="keyword">null</span> || !mActivityThread.post(args)) &#123;</div><div class="line">            <span class="keyword">if</span> (mRegistered &amp;&amp; ordered) &#123;</div><div class="line">                IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">              </div><div class="line">                args.sendFinished(mgr);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Arg 中的 run():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// ... </span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    ClassLoader cl =  mReceiver.getClass().getClassLoader();</div><div class="line">                    intent.setExtrasClassLoader(cl);</div><div class="line">                    intent.prepareToEnterProcess();</div><div class="line">                    setExtrasClassLoader(cl);</div><div class="line">                    receiver.setPendingResult(<span class="keyword">this</span>);</div><div class="line">                    <span class="comment">// 调用了 onReceive</span></div><div class="line">                    receiver.onReceive(mContext, intent);</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> (receiver.getPendingResult() != <span class="keyword">null</span>) &#123;</div><div class="line">                    finish();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h1 id="ContentProvider-的工作过程"><a href="#ContentProvider-的工作过程" class="headerlink" title="ContentProvider 的工作过程"></a>ContentProvider 的工作过程</h1><p>ContentProvider 是一种内容共享型组件，通过 Binder 向其他组件或应用提供数据。  </p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>当 ContentProvider 所在的进程启动时，ContenProvider 会同时被启动并被发布到 AMS 中。  </p>
<p><strong>这时 ContentProvider 的 <code>onCreate()</code> 要先于 Application 的 <code>onCreate()</code> 执行。</strong></p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://7xt4re.com1.z0.glb.clouddn.com/ContentProvider_OnCreate.png" alt=""></h2><p>ActivityThread#handleBindApplication 中的代码片段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// ....</span></div><div class="line"></div><div class="line"><span class="comment">// 先初始化 ContentProviders</span></div><div class="line"><span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</div><div class="line"></div><div class="line">installContentProviders(app, data.providers);</div><div class="line">    <span class="comment">// For process that contains content providers, we want to</span></div><div class="line">    <span class="comment">// ensure that the JIT is enabled "at some point".</span></div><div class="line">    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</div><div class="line">&#125;</div><div class="line">            </div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"></div><div class="line"><span class="comment">// 接着调用 application 的 onCreate</span></div><div class="line">mInstrumentation.callApplicationOnCreate(app);</div></pre></td></tr></table></figure></p>
<p>ContentProvider 启动完成后，外界就可以通过它提供的增删改查四个接口来操作 ContentProvider 中的数据。<br>即通过 Binder 调用 <code>insert</code>、<code>delete</code>、<code>update</code>、<code>query</code> 四个方法。</p>
<p>外界无法直接访问 ContentProvider，只能通过 AMS 根据 Uri 来获取对应的 ContentProvider 的 Binder 接口 IContentProvider，然后通过它访问内部的数据。</p>
<h2 id="单实例"><a href="#单实例" class="headerlink" title="单实例"></a>单实例</h2><p>一般来说，ContentProvider 都是单实例。<br>这由属性 <code>android:multiprocess</code> 决定，false 即为单实例，默认为 false。  </p>
<p>开启多实例时，在每个调用者的进程中都存在一个 ContentProvider 对象。<br>在实际开发中，并未出现多实例的具体使用场景，官方解释这样可以减少进程间通信的开销。  </p>
<h2 id="访问-ContentProvider"><a href="#访问-ContentProvider" class="headerlink" title="访问 ContentProvider"></a>访问 ContentProvider</h2><p>需要通过 ContentResolver。这是个抽象类。实现类是 ContextImpl$ApplicationContentResolver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentResolver</span></span></div></pre></td></tr></table></figure>
<p>当 ContentProvider 所在的线程为启动时，第一次访问它就会触发 ContentProvider 的创建。通过 ContentResolver 的四个方法都可以触发。</p>
<p>ContextImpl$ApplicationContentResolver#query<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> <span class="function">Cursor <span class="title">query</span><span class="params">(<span class="keyword">final</span> @RequiresPermission.Read @NonNull Uri uri,</span></span></div><div class="line">           @Nullable String[] projection, @Nullable String selection,</div><div class="line">           @Nullable String[] selectionArgs, @Nullable String sortOrder,</div><div class="line">           @Nullable CancellationSignal cancellationSignal) &#123;</div><div class="line">       <span class="comment">// ....</span></div><div class="line">       </div><div class="line">       </div><div class="line">       </div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// ... </span></div><div class="line">         </div><div class="line">           </div><div class="line">           <span class="comment">// Wrap the cursor object into CursorWrapperInner object.</span></div><div class="line">           <span class="comment">// 获取 IContentProvider 对象</span></div><div class="line">       </div><div class="line">           <span class="keyword">final</span> IContentProvider provider = (stableProvider != <span class="keyword">null</span>) ? stableProvider</div><div class="line">                   : acquireProvider(uri);</div><div class="line">           </div><div class="line">           </div><div class="line">           <span class="comment">// ...</span></div><div class="line">          </div><div class="line">           <span class="keyword">return</span> wrapper;</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          </div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p><code>acquireProvider()</code> 最终调用了 ActivityThread 的 <code>acquireProvider()</code>。</p>
<p>ActivityThread#acquireProvider<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title">acquireProvider</span><span class="params">(</span></span></div><div class="line">           Context c, String auth, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> stable) &#123;</div><div class="line">       </div><div class="line">       <span class="comment">// 首先查找是否已经存在，存在的话直接返回</span></div><div class="line">       <span class="keyword">final</span> IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);</div><div class="line">       <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> provider;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   </div><div class="line">       <span class="comment">// 当 2 个进程同时请求时，只会保证第一个成功。无法用锁，因为请求需要很长时间，同一个进程可能会重新进入锁。</span></div><div class="line">       </div><div class="line">       </div><div class="line">       <span class="comment">// 没有查找到就发送一个进程间请求给 AMS 让其启动</span></div><div class="line">       IActivityManager.ContentProviderHolder holder = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           holder = ActivityManagerNative.getDefault().getContentProvider(</div><div class="line">                   getApplicationThread(), auth, userId, stable);</div><div class="line">       &#125;</div><div class="line">   </div><div class="line"></div><div class="line">       <span class="comment">// Install provider will increment the reference count for us, and break</span></div><div class="line">       <span class="comment">// any ties in the race.</span></div><div class="line">       </div><div class="line">       <span class="comment">// 修改引用计数</span></div><div class="line">       holder = installProvider(c, holder, holder.info,</div><div class="line">               <span class="keyword">true</span> <span class="comment">/*noisy*/</span>, holder.noReleaseNeeded, stable);</div><div class="line">       <span class="keyword">return</span> holder.provider;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="AMS-是如何启动-ContentProvider的？"><a href="#AMS-是如何启动-ContentProvider的？" class="headerlink" title="AMS 是如何启动 ContentProvider的？"></a>AMS 是如何启动 ContentProvider的？</h2><p>上面的 <code>getContentProvider()</code> 调用了 <code>getContentProviderImpl()</code></p>
<p>AMS#getContentProviderImpl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">            String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId) &#123;</div><div class="line"><span class="comment">// ... </span></div><div class="line"><span class="comment">//  通过 startProcessLocked 启动进程</span></div><div class="line">proc = startProcessLocked(cpi.processName,</div><div class="line">                            cpr.appInfo,</div><div class="line">                            <span class="keyword">false</span>,</div><div class="line">                            <span class="number">0</span>,</div><div class="line">                            <span class="string">"content provider"</span>,</div><div class="line">                            <span class="keyword">new</span> ComponentName(cpi.applicationInfo.packageName,</div><div class="line">                                            cpi.name), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">       <span class="comment">// ...                  </span></div><div class="line">        <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>startProcessLocked()</code> 的内部通过 Progress 的 <code>start()</code> 来完成一个新进程的启动。  </p>
<p>新进程启动后的入口方法就是 ActivityThread 的 <code>main()</code>。<br>然后就和上述 <strong>启动过程</strong> 一样。</p>
<h2 id="完整的过程"><a href="#完整的过程" class="headerlink" title="完整的过程"></a>完整的过程</h2><p><img src="http://7xt4re.com1.z0.glb.clouddn.com/ContentProvider_Create.png" alt=""></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android开发艺术探索/" rel="tag"># Android开发艺术探索</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/20/androidArt8/" rel="next" title="Android开发艺术探索笔记-第8章 Window 的创建过程">
                <i class="fa fa-chevron-left"></i> Android开发艺术探索笔记-第8章 Window 的创建过程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/29/androidArt15/" rel="prev" title="Android开发艺术探索笔记-第15章 性能优化">
                Android开发艺术探索笔记-第15章 性能优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">fromzero</p>
              <p class="site-description motion-element" itemprop="description">fix myself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#四大组件的运行状态"><span class="nav-number">1.</span> <span class="nav-text">四大组件的运行状态</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Activity-的工作过程"><span class="nav-number">2.</span> <span class="nav-text">Activity 的工作过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AMS-和-ActivityStack-互相调用"><span class="nav-number">2.1.</span> <span class="nav-text">AMS 和 ActivityStack 互相调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IApplicationThread-及它的实现者"><span class="nav-number">2.2.</span> <span class="nav-text">IApplicationThread 及它的实现者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动-Activity-的具体细节"><span class="nav-number">2.3.</span> <span class="nav-text">启动 Activity 的具体细节</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Service-的工作过程"><span class="nav-number">3.</span> <span class="nav-text">Service 的工作过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启动过程"><span class="nav-number">3.1.</span> <span class="nav-text">启动过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-的绑定过程"><span class="nav-number">3.2.</span> <span class="nav-text">Service 的绑定过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通知客户端绑定成功"><span class="nav-number">3.2.1.</span> <span class="nav-text">通知客户端绑定成功</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BroadcastReceiver-的工作过程"><span class="nav-number">4.</span> <span class="nav-text">BroadcastReceiver 的工作过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#注册过程"><span class="nav-number">4.1.</span> <span class="nav-text">注册过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发送和接收过程"><span class="nav-number">4.2.</span> <span class="nav-text">发送和接收过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ContentProvider-的工作过程"><span class="nav-number">5.</span> <span class="nav-text">ContentProvider 的工作过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启动"><span class="nav-number">5.1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">5.2.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单实例"><span class="nav-number">5.3.</span> <span class="nav-text">单实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问-ContentProvider"><span class="nav-number">5.4.</span> <span class="nav-text">访问 ContentProvider</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AMS-是如何启动-ContentProvider的？"><span class="nav-number">5.5.</span> <span class="nav-text">AMS 是如何启动 ContentProvider的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完整的过程"><span class="nav-number">5.6.</span> <span class="nav-text">完整的过程</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fromzero</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
