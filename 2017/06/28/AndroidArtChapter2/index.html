<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>android开发艺术探索笔记-第2章 android的ipc机制 | luwenjie&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Android开发艺术探索" />
  
  
  
  
  <meta name="description" content="本章主要讲解Android中的IPC机制。首先介绍Android中的多进程概念以及多进程开发模式中常见的注意事项，接着介绍Android中的序列化机制和Binder，然后详细介绍Bundle、文件共享、AIDL、Messenger、ContentProvider和Socket等进程间通信的方式。为了更好地使用AIDL来进行进程间通信，本章还引入了Binder连接池的概念。最后，本章讲解各种进程间">
<meta name="keywords" content="Android开发艺术探索">
<meta property="og:type" content="article">
<meta property="og:title" content="Android开发艺术探索笔记-第2章 Android的IPC机制">
<meta property="og:url" content="https://luwenjie.me/2017/06/28/AndroidArtChapter2/index.html">
<meta property="og:site_name" content="luwenjie&#39;s Blog">
<meta property="og:description" content="本章主要讲解Android中的IPC机制。首先介绍Android中的多进程概念以及多进程开发模式中常见的注意事项，接着介绍Android中的序列化机制和Binder，然后详细介绍Bundle、文件共享、AIDL、Messenger、ContentProvider和Socket等进程间通信的方式。为了更好地使用AIDL来进行进程间通信，本章还引入了Binder连接池的概念。最后，本章讲解各种进程间">
<meta property="og:image" content="http://image.webreader.duokan.com/mfsv2/download/fdsc3/p01sbTujh7yS/SX5AJ9QwDfTjxD.jpg">
<meta property="og:image" content="http://gityuan.com/images/binder/prepare/IPC-Binder.jpg">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/20170615149751520160135.png">
<meta property="og:image" content="http://image.webreader.duokan.com/mfsv2/download/fdsc3/p01XLr0MNKfD/cQEfipyHxwyW9c.jpg">
<meta property="og:image" content="https://cdn.cnbj1.fds.api.mi-img.com/book/images/33fcd0776ee12b29e43bd819cf825f79">
<meta property="og:image" content="https://cdn.cnbj1.fds.api.mi-img.com/book/images/fa1eb34bd7621f9d36bc75e5a2386970">
<meta property="og:updated_time" content="2017-07-15T05:20:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android开发艺术探索笔记-第2章 Android的IPC机制">
<meta name="twitter:description" content="本章主要讲解Android中的IPC机制。首先介绍Android中的多进程概念以及多进程开发模式中常见的注意事项，接着介绍Android中的序列化机制和Binder，然后详细介绍Bundle、文件共享、AIDL、Messenger、ContentProvider和Socket等进程间通信的方式。为了更好地使用AIDL来进行进程间通信，本章还引入了Binder连接池的概念。最后，本章讲解各种进程间">
<meta name="twitter:image" content="http://image.webreader.duokan.com/mfsv2/download/fdsc3/p01sbTujh7yS/SX5AJ9QwDfTjxD.jpg">
  
    <link rel="alternate" href="/atom.xml" title="luwenjie&#39;s Blog" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-AndroidArtChapter2" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Android开发艺术探索笔记-第2章 Android的IPC机制
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/06/28/AndroidArtChapter2/" class="article-date">
	  <time datetime="2017-06-28T08:37:00.000Z" itemprop="datePublished">2017-06-28</time>
	</a>

      
    <a class="article-category-link" href="/categories/Android/">Android</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本章主要讲解Android中的IPC机制。首先介绍Android中的多进程概念以及多进程开发模式中常见的注意事项，接着介绍Android中的序列化机制和Binder，然后详细介绍Bundle、文件共享、AIDL、Messenger、ContentProvider和Socket等进程间通信的方式。为了更好地使用AIDL来进行进程间通信，本章还引入了Binder连接池的概念。最后，本章讲解各种进程间通信方式的优缺点和适用场景。通过本章，可以让读者对Android中的IPC机制和多进程开发模式有深入的理解。</p>
</blockquote>
<a id="more"></a>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>IPC (Inter-Process Communication)：进程间通信或者跨进程通信，指 2 个进程之间进行数据交换的过程。</p>
<p>线程：CPU 调度的最小单元。<br>进程：一个执行单元，在 PC 和移动设备上指一个程序或者一个应用。  </p>
<p>一个进程可以包含多个线程。</p>
<p>其他操作系统的 IPC 机制：</p>
<p>Windows：剪贴板，管道，邮槽 </p>
<h2 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h2><ol>
<li>App 因为某些原因，有些模块需要运行在单独的线程中。</li>
<li>加大一个 App 的可使用内存。多线程可以获取更多的可使用内存限制。</li>
<li>2 个 App 之间传递数据。</li>
</ol>
<h1 id="Android-中的多进程模式"><a href="#Android-中的多进程模式" class="headerlink" title="Android 中的多进程模式"></a>Android 中的多进程模式</h1><h2 id="开启多进程"><a href="#开启多进程" class="headerlink" title="开启多进程"></a>开启多进程</h2><ol>
<li>在 AndroidMenifest 文件中指定四大组件（Activity、Service、Receiver、ContentProvider）的 <code>android:process</code> 属性。</li>
<li>通过 JNI 在 native 层 fork 一个新的进程。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".BAct"</span></span></div><div class="line">        <span class="attr">android:process</span>=<span class="string">":ThreadB"</span>/&gt;</div><div class="line">        </div><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".BAct"</span></span></div><div class="line">        <span class="attr">android:process</span>=<span class="string">".ThreadB"</span>/&gt;</div></pre></td></tr></table></figure>
<p>process 的命名：</p>
<ol>
<li>以<code>:</code>为前缀：在当前进程前面加上包名。属于当前App的私有进程，其他App的组件不可以和她跑在同一个进程中。</li>
<li>以<code>.</code>为前缀：不会附加包名。全局进程，其他App通过 <code>ShareUID</code> 的方式可以和她跑在一个进程中。</li>
</ol>
<h2 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h2><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".SecondActivity"</span></span></div><div class="line">      <span class="attr">android:process</span>=<span class="string">":secondThread"</span></div><div class="line">      /&gt;</div></pre></td></tr></table></figure>
<p>UserManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserManager</span>  </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> sUserId = <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MainActivity#onCreate<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">       setContentView(R.layout.activity_main);</div><div class="line">       UserManager.sUserId += <span class="number">1</span>;</div><div class="line">       Log.d(TAG, <span class="string">"userId = "</span> + UserManager.sUserId);</div><div class="line">       startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, SecondActivity.class));</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>SecondActivity#onCreate<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    Log.d(TAG, <span class="string">"userId = "</span> + UserManager.sUserId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>指定 SecondActivity 的 <code>process</code> 为 <code>:secondThread</code>, 在主线程中先将 userId +1，再打开 SecondActivity, 分别打印 userId 的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">06</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">06</span>:<span class="number">49.639</span> <span class="number">5078</span>-<span class="number">5078</span>/com.venjer.ibinderdemo D/MainActivity: userId = <span class="number">2</span></div><div class="line"><span class="number">06</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">06</span>:<span class="number">50.668</span> <span class="number">5171</span>-<span class="number">5171</span>/com.venjer.ibinderdemo:secondThread D/SecondActivity: userId = <span class="number">1</span></div></pre></td></tr></table></figure>
<p>结果他们的值是不一样的。</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>Android 为每一个 App 分配一个独立的虚拟机，不同的虚拟机在内存分配上有不同的地址空间，导致在不同的虚拟机中访问同一个类的对象会产生多个副本。</p>
<h3 id="使用多进程造成的问题"><a href="#使用多进程造成的问题" class="headerlink" title="使用多进程造成的问题"></a>使用多进程造成的问题</h3><ol>
<li>静态成员和单例模式完全失效</li>
<li>线程同步机制完全失效<blockquote>
<p>锁的不是同一块内存的对象</p>
</blockquote>
</li>
<li>Sharepreferences 的可靠性下降<blockquote>
<p>SharedPreferences不支持两个进程同时去执行写操作，否则会导致一定几率的数据丢失, 因为 SharedPreferences 底层是通过读/写XML文件来实现的，并发写显然是可能出问题的，甚至并发读/写都有可能出问题。</p>
</blockquote>
</li>
<li>Application 会多次创建<blockquote>
<p>运行在同一个进程中的组件是属于同一个虚拟机和同一个Application的，同理，运行在不同进程中的组件是属于两个不同的虚拟机和Application。</p>
</blockquote>
</li>
</ol>
<h3 id="系统提供跨进程方式解决"><a href="#系统提供跨进程方式解决" class="headerlink" title="系统提供跨进程方式解决"></a>系统提供跨进程方式解决</h3><ol>
<li>使用 Intent 传递数据</li>
<li>基于 Binder 的 Messenger 和 AIDL 以及 Socket。</li>
</ol>
<h1 id="IPC-基础概念"><a href="#IPC-基础概念" class="headerlink" title="IPC 基础概念"></a>IPC 基础概念</h1><h2 id="Serializable-接口"><a href="#Serializable-接口" class="headerlink" title="Serializable 接口"></a>Serializable 接口</h2><p>Serializable 是 Java 所提供的一个序列化接口。  </p>
<p>在类的声明中指定类似下面的标识<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8711368828010083044L</span>;</div></pre></td></tr></table></figure></p>
<p>不添加 <code>serialVersionUID</code> 也可以序列化，但是会对反序列化过程产生影响。  </p>
<p>使用 <code>ObjectOutputStream</code> 和 <code>ObjectInputStream</code> 实现正反序列化。  </p>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">519067123721295773L</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> userId;</div><div class="line">    <span class="keyword">public</span> String userName;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isMale;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">User user = <span class="keyword">new</span> User();</div><div class="line">user.isMale = <span class="keyword">true</span>;</div><div class="line">user.userName = <span class="string">"djkh"</span>;</div><div class="line">user.userId = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 序列化</span></div><div class="line">    ObjectOutputStream outputStream =</div><div class="line">        <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"cache.txt"</span>));</div><div class="line">    outputStream.writeObject(user);</div><div class="line">    outputStream.close();</div><div class="line">    </div><div class="line">    <span class="comment">// 反序列化</span></div><div class="line">    ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"cache.txt"</span>));</div><div class="line">    User newUser = (User) inputStream.readObject();</div><div class="line">    inputStream.close();</div><div class="line">    Log.d(TAG,newUser.userName);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="serialVersionUID-的工作机制"><a href="#serialVersionUID-的工作机制" class="headerlink" title="serialVersionUID 的工作机制"></a>serialVersionUID 的工作机制</h3><p>原则上序列化后的数据中的 serialVersionUID 只有和当前类的 serialVersionUID 相同时才能正常的被反序列化。</p>
<p>序列化的时候系统会把当前类的 serialVersionUID 写入序列化的文件中(也可能是其他中介)。反序列化的时候检查 serialVersionUID, 如果和之前不一致会报如下错误。  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java.io.InvalidClassException: Main; </div><div class="line">local class incompatible: </div><div class="line">stream     classdesc serialVersionUID = 8711368828010083044,</div><div class="line">local class serial-     VersionUID = 8711368828010083043。</div></pre></td></tr></table></figure>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>静态成员变量不属于对象，不会参与序列化过程</li>
<li>使用 transient 关键字标记的成员变量不会参与序列化过程</li>
</ol>
<h2 id="Parcelable-接口"><a href="#Parcelable-接口" class="headerlink" title="Parcelable 接口"></a>Parcelable 接口</h2><p>实现 Parcelable 接口的对象可以通过 Intent 和 Binder 传递。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">int</span> asd;</div><div class="line">  <span class="keyword">public</span> String asd1;</div><div class="line">  <span class="keyword">public</span> String asd2;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">User</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">    asd = in.readInt();</div><div class="line">    asd1 = in.readString();</div><div class="line">    asd2 = in.readString();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="keyword">new</span> Creator&lt;User&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> User <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> User(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> User[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> User[size];</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    parcel.writeInt(asd);</div><div class="line">    parcel.writeString(asd1);</div><div class="line">    parcel.writeString(asd2);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Parcel"><a href="#Parcel" class="headerlink" title="Parcel"></a>Parcel</h2><p>内部包装了可序列化的数据，可以在 Binder 中自由传输。     </p>
<p>writeToParcel: 序列化<br>CREATOR：反序列化，内部标明了如何创建序列化对象和数组。<br>describeContents: 内容描述功能，默认返回0；仅当对象中存在文件描述时返回 1。</p>
<p><img src="http://image.webreader.duokan.com/mfsv2/download/fdsc3/p01sbTujh7yS/SX5AJ9QwDfTjxD.jpg" alt=""></p>
<h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>Parcelable 效率较高，主要用在内存序列化上。<br>将对象序列化到存储设备中或者将对象序列化后通过网络传输建议使用 Serializable。</p>
<h1 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h1><p>android.os.Binder 是一个类，实现了 IBinder 接口。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IBinder</span></span></div></pre></td></tr></table></figure>
<p>Binder 是 Android 中的一种跨进程通信方式，可以理解为一种虚拟的物理设备，设备驱动是 dev/binder。  </p>
<ul>
<li>从 Framework 角度来说，Binder 是 ServiceManager 连接各种 Manager（ActivityManager、WindowManager..）和相应的 ManagerService 的桥梁。</li>
<li>从 Android 应用层来说，Binder 是客户端和服务端进行通信的媒介。</li>
</ul>
<p>图片来自<a href="http://gityuan.com/about/" target="_blank" rel="external">@Gityuan</a><br><img src="http://gityuan.com/images/binder/prepare/IPC-Binder.jpg" alt=""></p>
<h2 id="AIDL-的例子"><a href="#AIDL-的例子" class="headerlink" title="AIDL 的例子"></a>AIDL 的例子</h2><p>新建实体类 Book，实现 Parcelable 接口。在 aidl 文件中引用自定义的对象需要同时声明那个对象的aidl。</p>
<p>Book.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Parcel;</div><div class="line"><span class="keyword">import</span> android.os.Parcelable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * created by venjer on 15/06/2017 14:13</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;Book&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Book&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Book <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Book(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Book[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Book[size];</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> bookId;</div><div class="line">  <span class="keyword">private</span> String bookName;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">Book</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">    bookId = in.readInt();</div><div class="line">    bookName = in.readString();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBookId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> bookId;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookId</span><span class="params">(<span class="keyword">int</span> bookId)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.bookId = bookId;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getBookName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> bookName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookName</span><span class="params">(String bookName)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.bookName = bookName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    parcel.writeInt(bookId);</div><div class="line">    parcel.writeString(bookName);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Book.aidl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Book.aidl</span></div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line">parcelable Book;</div></pre></td></tr></table></figure></p>
<p>IBookManager.aidl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IBookManager.aidl</span></div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="keyword">import</span> me.luwenjie.myapplication.Book;</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(in Book book)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>系统根据 IBookManager.aidl 自动生成的 IBookManager.java 接口。<br>它继承了 IInterface 接口，定义了 aidl 中声明的方法。同时内部有一个继承 android.os.Binder 的 Stub 静态抽象类。Stub 内部还有一个静态 Proxy 代理类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * This file is auto-generated.  DO NOT MODIFY.</div><div class="line"> * Original file: /Users/venjerLu/Documents/AndroidStudioStorage/MyApplication2/app/src/main/aidl/me/luwenjie/myapplication/IBookManager.aidl</div><div class="line"> */</div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> java.util.List&lt;me.luwenjie.myapplication.Book&gt; getBookList()</div><div class="line">      <span class="keyword">throws</span> android.os.RemoteException;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(me.luwenjie.myapplication.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Local-side IPC implementation stub class. */</span></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 客户端和服务端都位于同一个进程时，方法调用不会走 transact 过程，位于不同进程时，</div><div class="line">   * 方法调用需要走 transact 过程，这个逻辑由 Proxy 代理类完成。</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span></span></div><div class="line">      <span class="keyword">implements</span> <span class="title">me</span>.<span class="title">luwenjie</span>.<span class="title">myapplication</span>.<span class="title">IBookManager</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">/** 声明2个整型的id分别用于标识这2个方法，用于标识在 transact 过程中客户端请求的是哪个方法。 */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBookList = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">/** Binder 的唯一标识 */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"me.luwenjie.myapplication.IBookManager"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Construct the stub at attach it to the interface. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cast an IBinder object into an me.luwenjie.myapplication.IBookManager interface,</div><div class="line">     * generating a proxy if needed.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将服务端的 Binder 对象转换成客户端所需的 AIDL 接口类型的对象</div><div class="line">     * 如果是同一进程，返回 Stub 对象本身。不同进程返回的是 Stub.Proxy</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> me.luwenjie.myapplication.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">      <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> me.luwenjie.myapplication.IBookManager))) &#123;</div><div class="line">        <span class="keyword">return</span> ((me.luwenjie.myapplication.IBookManager) iin);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> me.luwenjie.myapplication.IBookManager.Stub.Proxy(obj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 返回当前的 Binder 对象</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 运行在服务端中的 Binder 线程池中。当客户端发起跨进程请求时，远程请求会通过系统底层封装</div><div class="line">     * 后交由此方法处理。</div><div class="line">     * <span class="doctag">@param</span> code 通过 code 确定客户端请求的目标方法是什么</div><div class="line">     * <span class="doctag">@param</span> data 从 data 中取出目标方法所需要的参数，然后执行目标方法。</div><div class="line">     * <span class="doctag">@param</span> reply 目标方法执行完毕后向 reply 中写入返回值</div><div class="line">     * <span class="doctag">@param</span> flags 额外的操作标记，默认的RPC是0，单向的RPC是&#123;<span class="doctag">@link</span> #FLAG_ONEWAY&#125;</div><div class="line">     * <span class="doctag">@return</span> 返回false客户端的请求会失败。因此我们可以利用这个特性来做权限验证，毕竟我们也不希望随便一个进程都能远程调</div><div class="line">     *         用我们的服务</div><div class="line">     * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span></span></div><div class="line">        <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">      <span class="keyword">switch</span> (code) &#123;</div><div class="line">        <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</div><div class="line">          reply.writeString(DESCRIPTOR);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> TRANSACTION_getBookList: &#123;</div><div class="line">          data.enforceInterface(DESCRIPTOR);</div><div class="line">          java.util.List&lt;me.luwenjie.myapplication.Book&gt; _result = <span class="keyword">this</span>.getBookList();</div><div class="line">          reply.writeNoException();</div><div class="line">          reply.writeTypedList(_result);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> TRANSACTION_addBook: &#123;</div><div class="line">          data.enforceInterface(DESCRIPTOR);</div><div class="line">          me.luwenjie.myapplication.Book _arg0;</div><div class="line">          <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">            _arg0 = me.luwenjie.myapplication.Book.CREATOR.createFromParcel(data);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            _arg0 = <span class="keyword">null</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">this</span>.addBook(_arg0);</div><div class="line">          reply.writeNoException();</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">me</span>.<span class="title">luwenjie</span>.<span class="title">myapplication</span>.<span class="title">IBookManager</span> </span>&#123;</div><div class="line">      <span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line"></div><div class="line">      Proxy(android.os.IBinder remote) &#123;</div><div class="line">        mRemote = remote;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> DESCRIPTOR;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * 运行在客户端</div><div class="line">       * <span class="doctag">@return</span></div><div class="line">       * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">       */</div><div class="line">      <span class="meta">@Override</span> <span class="keyword">public</span> java.util.List&lt;me.luwenjie.myapplication.Book&gt; getBookList()</div><div class="line">          <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        <span class="comment">// 创建输入型 Parcel 对象 _data, 输出型对象 _reply</span></div><div class="line">        android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">        android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">        java.util.List&lt;me.luwenjie.myapplication.Book&gt; _result;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line"></div><div class="line">          <span class="comment">// 发起 RPC(远程过程调用)请求，同时当前线程挂起，服务端的 onTarnsact 会被调用。</span></div><div class="line">          <span class="comment">// RPC 过程返回后，当前线程继续执行，从 _reply 中取出 RPC 过程的返回结果，最后返回 _reply</span></div><div class="line">          <span class="comment">// 中的数据。</span></div><div class="line">          mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</div><div class="line">          _reply.readException();</div><div class="line">          _result = _reply.createTypedArrayList(me.luwenjie.myapplication.Book.CREATOR);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          _reply.recycle();</div><div class="line">          _data.recycle();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> _result;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * 和 getBookList 一样。它没有返回值，所以不需要从 _reply 中取值。</div><div class="line">       * <span class="doctag">@param</span> book</div><div class="line">       * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">       */</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(me.luwenjie.myapplication.Book book)</span></span></div><div class="line">          <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">        android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">          <span class="keyword">if</span> ((book != <span class="keyword">null</span>)) &#123;</div><div class="line">            _data.writeInt(<span class="number">1</span>);</div><div class="line">            book.writeToParcel(_data, <span class="number">0</span>);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            _data.writeInt(<span class="number">0</span>);</div><div class="line">          &#125;</div><div class="line">          mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</div><div class="line">          _reply.readException();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          _reply.recycle();</div><div class="line">          _data.recycle();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Binder-的工作机制"><a href="#Binder-的工作机制" class="headerlink" title="Binder 的工作机制"></a>Binder 的工作机制</h2><ol>
<li>当客户端发起远程请求时，当前线程会被挂起直至服务端返回数据，如果一个远程方法是很耗时的，那么不能在 UI 线程中发起请求。</li>
<li>因为服务端的 Binder 方法运行在 Binder 的线程池中，所以 Binder 方法不管是否耗时都应该采用同步的方式去实现。因为它已经运行在一个线程中了。</li>
</ol>
<p><img src="http://7xt4re.com1.z0.glb.clouddn.com/20170615149751520160135.png" alt=""></p>
<h2 id="手动实现-Binder"><a href="#手动实现-Binder" class="headerlink" title="手动实现 Binder"></a>手动实现 Binder</h2><p>AIDL 是为了方便生成代码。系统根据 AIDL 生成代码的格式是固定的。</p>
<p>将 Stub 从生成的代码中剥离出来。</p>
<p>IBookManager<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">IInterface</span></span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/** 声明2个整型的id分别用于标识这2个方法，用于标识在 transact 过程中客户端请求的是哪个方法。 */</span></div><div class="line">  <span class="keyword">int</span> TRANSACTION_getBookList = (android.os.IBinder.FIRST_CALL_TRANSACTION);</div><div class="line">  <span class="keyword">int</span> TRANSACTION_addBook = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="comment">/** Binder 的唯一标识 */</span></div><div class="line">  java.lang.String DESCRIPTOR = <span class="string">"me.luwenjie.myapplication.IBookManager"</span>;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span><span class="keyword">throws</span> RemoteException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BookManagerImpl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookManagerImpl</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IBookManager</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BookManagerImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//super();</span></div><div class="line">    <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, IBookManager.DESCRIPTOR);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 将服务端的 Binder 对象转换成客户端所需的 AIDL 接口类型的对象</div><div class="line">   * 如果是同一进程，返回 Stub 对象本身。不同进程返回的是 Stub.Proxy</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">    <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> IBookManager))) &#123;</div><div class="line">      <span class="keyword">return</span> ((IBookManager) iin);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Proxy(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 运行在服务端中的 Binder 线程池中。当客户端发起跨进程请求时，远程请求会通过系统底层封装</div><div class="line">   * 后交由此方法处理。</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> code 通过 code 确定客户端请求的目标方法是什么</div><div class="line">   * <span class="doctag">@param</span> data 从 data 中取出目标方法所需要的参数，然后执行目标方法。</div><div class="line">   * <span class="doctag">@param</span> reply 目标方法执行完毕后向 reply 中写入返回值</div><div class="line">   * <span class="doctag">@param</span> flags 额外的操作标记，默认的RPC是0，单向的RPC是&#123;<span class="doctag">@link</span> #FLAG_ONEWAY&#125;</div><div class="line">   * <span class="doctag">@return</span> 返回false客户端的请求会失败。因此我们可以利用这个特性来做权限验证，毕竟我们也不希望随便一个进程都能远程调</div><div class="line">   * 用我们的服务</div><div class="line">   * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">   */</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">      <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">      <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</div><div class="line">        reply.writeString(DESCRIPTOR);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">case</span> TRANSACTION_getBookList: &#123;</div><div class="line">        data.enforceInterface(DESCRIPTOR);</div><div class="line">        java.util.List&lt;me.luwenjie.myapplication.Book&gt; _result = <span class="keyword">this</span>.getBookList();</div><div class="line">        reply.writeNoException();</div><div class="line">        reply.writeTypedList(_result);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">case</span> TRANSACTION_addBook: &#123;</div><div class="line">        data.enforceInterface(DESCRIPTOR);</div><div class="line">        me.luwenjie.myapplication.Book _arg0;</div><div class="line">        <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">          _arg0 = me.luwenjie.myapplication.Book.CREATOR.createFromParcel(data);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          _arg0 = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.addBook(_arg0);</div><div class="line">        reply.writeNoException();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">IBookManager</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line"></div><div class="line">    Proxy(android.os.IBinder remote) &#123;</div><div class="line">      mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> DESCRIPTOR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 运行在客户端</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> java.util.<span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span></div><div class="line">        <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">      <span class="comment">// 创建输入型 Parcel 对象 _data, 输出型对象 _reply</span></div><div class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">      java.util.List&lt;me.luwenjie.myapplication.Book&gt; _result;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line"></div><div class="line">        <span class="comment">// 发起 RPC(远程过程调用)请求，同时当前线程挂起，服务端的 onTarnsact 会被调用。</span></div><div class="line">        <span class="comment">// RPC 过程返回后，当前线程继续执行，从 _reply 中取出 RPC 过程的返回结果，最后返回 _reply</span></div><div class="line">        <span class="comment">// 中的数据。</span></div><div class="line">        mRemote.transact(TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</div><div class="line">        _reply.readException();</div><div class="line">        _result = _reply.createTypedArrayList(me.luwenjie.myapplication.Book.CREATOR);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        _reply.recycle();</div><div class="line">        _data.recycle();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> _result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 和 getBookList 一样。它没有返回值，所以不需要从 _reply 中取值。</div><div class="line">     * <span class="doctag">@param</span> book</div><div class="line">     * <span class="doctag">@throws</span> android.os.RemoteException</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span></span></div><div class="line">        <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">        <span class="keyword">if</span> ((book != <span class="keyword">null</span>)) &#123;</div><div class="line">          _data.writeInt(<span class="number">1</span>);</div><div class="line">          book.writeToParcel(_data, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          _data.writeInt(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        mRemote.transact(TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</div><div class="line">        _reply.readException();</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        _reply.recycle();</div><div class="line">        _data.recycle();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="linkToDeath-和-unlinkToDeath"><a href="#linkToDeath-和-unlinkToDeath" class="headerlink" title="linkToDeath 和 unlinkToDeath"></a>linkToDeath 和 unlinkToDeath</h2><p>Binder 运行在服务端进程，如果服务端进程异常终止，这时客户端到服务端的连接断开(Binder死亡)，导致调用失败。  </p>
<p>通过 linkToDeath 给 Binder 设置一个死亡代理，当 Bidner 死亡时，我们就会收到通知。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Register the recipient for a notification if this binder</div><div class="line">  * goes away.  If this binder object unexpectedly goes away</div><div class="line">  * (typically because its hosting process has been killed),</div><div class="line">  * then the given &#123;<span class="doctag">@link</span> DeathRecipient&#125;'s</div><div class="line">  * &#123;<span class="doctag">@link</span> DeathRecipient#binderDied DeathRecipient.binderDied()&#125; method</div><div class="line">  * will be called.</div><div class="line">  * </div><div class="line">  * &lt;p&gt;You will only receive death notifications for remote binders,</div><div class="line">  * as local binders by definition can't die without you dying as well.</div><div class="line">  * </div><div class="line">  * <span class="doctag">@throws</span> RemoteException if the target IBinder's</div><div class="line">  * process has already died.</div><div class="line">  * </div><div class="line">  * <span class="doctag">@see</span> #unlinkToDeath</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">linkToDeath</span><span class="params">(DeathRecipient recipient, <span class="keyword">int</span> flags)</span></span></div><div class="line">         <span class="keyword">throws</span> RemoteException;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Interface for receiving a callback when the process hosting an IBinder</div><div class="line">  * has gone away.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@see</span> #linkToDeath</div><div class="line">  */</div><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeathRecipient</span> </span>&#123;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span></span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>当 Binder 死亡时，系统就会回调 binderDied 方法。</p>
<h2 id="Android-中的-IPC-方式"><a href="#Android-中的-IPC-方式" class="headerlink" title="Android 中的 IPC 方式"></a>Android 中的 IPC 方式</h2><h3 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bundle</span> <span class="keyword">extends</span> <span class="title">BaseBundle</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Parcelable</span></span></div></pre></td></tr></table></figure>
<p>Bundle 实现了 Parcelable 接口，可以方便的在不同的进程之间传输。  </p>
<p>只能传输 Bundle 支持的数据。  </p>
<h3 id="使用文件共享"><a href="#使用文件共享" class="headerlink" title="使用文件共享"></a>使用文件共享</h3><p>2 个文件通过读/写同一个文件来交换数据。有一定的局限性，比如并发读/写的问题。</p>
<p>适合在对数据同步要求不高的进程之间进行通信，并且要求妥善处理并发读/写的问题。</p>
<p>SharePreference 是 Android 中的轻量级存储方案。</p>
<p>它通过键值对的方式来存储数据，底层采用 XML 文件来存储键值对。本质上 SharePreference 也属于文件的一种，由于系统对它的读写有一定的缓存策略，内存中会有一份 SharePreference 文件的缓存，多进程的时候变得不可靠，有很大几率丢失数据。</p>
<h3 id="使用-Messenger"><a href="#使用-Messenger" class="headerlink" title="使用 Messenger"></a>使用 Messenger</h3><p>一种轻量级的 IPC 方案，底层实现是 AIDL。  </p>
<p>构造方法可以看出 AIDL 的痕迹。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Messenger</span><span class="params">(Handler target)</span> </span>&#123;</div><div class="line">    mTarget = target.getIMessenger();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Messenger</span><span class="params">(IBinder target)</span> </span>&#123;</div><div class="line">    mTarget = IMessenger.Stub.asInterface(target);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>例子： </p>
<p>客户端 MessengerActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessengerActivity"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Messenger clientMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> WeakHandler(<span class="keyword">this</span>));</div><div class="line">  <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">      <span class="comment">// 得到服务端的 Messenger</span></div><div class="line">      Messenger service1 = <span class="keyword">new</span> Messenger(service);</div><div class="line">      Message message = Message.obtain(<span class="keyword">null</span>, MessengerService.MSG_FROM_CLIENT);</div><div class="line">      Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">      bundle.putString(<span class="string">"msg"</span>, <span class="string">"hello,this is client"</span>);</div><div class="line">      message.setData(bundle);</div><div class="line">      message.replyTo = clientMessenger;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        service1.send(message);</div><div class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_messenger);</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MessengerService.class);</div><div class="line">    bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    unbindService(mConnection);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;MessengerActivity&gt; mActivity;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeakHandler</span><span class="params">(MessengerActivity activity)</span> </span>&#123;</div><div class="line">      mActivity = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">      MessengerActivity activity = mActivity.get();</div><div class="line">      <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">          <span class="keyword">case</span> MessengerService.MSG_FROM_SERVICE:</div><div class="line">            Log.d(TAG, <span class="string">"receive msg from Service:"</span> + msg.getData().getString(<span class="string">"reply"</span>));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>服务端 MessengerService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_FROM_CLIENT = <span class="number">0X1000</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_FROM_SERVICE = <span class="number">0X1001</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessengerService"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Messenger messenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> MessengerHandler());</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> messenger.getBinder();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">      <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> MSG_FROM_CLIENT:</div><div class="line">          Log.d(TAG,<span class="string">"receive msg from Client:"</span> + msg.getData().getString(<span class="string">"msg"</span>));</div><div class="line">          <span class="comment">// 得到客户端的 Messenger</span></div><div class="line">          Messenger client = msg.replyTo;</div><div class="line"></div><div class="line">          Message replyMsg = Message.obtain(<span class="keyword">null</span>, MSG_FROM_SERVICE);</div><div class="line">          Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">          bundle.putString(<span class="string">"reply"</span>,<span class="string">"yes，i have received, i will reply to you after a moment"</span>);</div><div class="line">          replyMsg.setData(bundle);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            client.send(replyMsg);</div><div class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">       <span class="attr">android:name</span>=<span class="string">".MessengerService"</span></div><div class="line">       <span class="attr">android:process</span>=<span class="string">":remote"</span>/&gt;</div></pre></td></tr></table></figure>
<p>在 Messenger 中进行数据传输必须将数据放入 Message 中，Messenger 和 Message 都实现了 Parcelable 接口，因此可以跨进程传输。  </p>
<p>Message 可以使用的载体：  </p>
<ol>
<li>arg1</li>
<li>arg2</li>
<li><p>object</p>
<blockquote>
<p>2.2 之前不支持跨进程, 2.2 之后只支持系统提供的 Parcelable 对象传输</p>
</blockquote>
</li>
<li><p>Bundle</p>
</li>
<li>replyTo</li>
</ol>
<p>Messenger 的工作原理：</p>
<p><img src="http://image.webreader.duokan.com/mfsv2/download/fdsc3/p01XLr0MNKfD/cQEfipyHxwyW9c.jpg" alt=""></p>
<h3 id="使用-AIDL"><a href="#使用-AIDL" class="headerlink" title="使用 AIDL"></a>使用 AIDL</h3><p>Messenger 以串行的方式处理客户端发来的消息，如果有大量的消息同时发送，服务端仍然只能一个个处理。</p>
<p>ADIL 支持的数据类型：  </p>
<ol>
<li>基本数据类型, String, CharSequence</li>
<li>List, 只支持 ArrayList, 里面每个元素都必须能够被 AIDL 支持</li>
<li>Map, 只支持 HashMap，里面每个元素都必须被 AIDL 支持，包括 key 和 value</li>
<li>Parcelable</li>
<li>AIDL, 所有 AIDL 接口本身也可以在 AIDL 文件中使用</li>
</ol>
<p>除了基本类，其他类型的参数必须标上方向：in(输入型参数), out(输出型参数), inout(输入输出型参数)</p>
<ul>
<li>客户端调用服务端的方法，被调用的方法运行在 Binder 线程池中，同时客户端被挂起，如果服务端的方法比较耗时，并且客户端运行在UI线程就会发生 ANR。避免在客户端的 UI 线程访问远程方法。</li>
<li>服务端的方法本身就运行在 Binder 线程池，可以执行大量任务。非常不建议在服务端方法中开启线程去进行异步任务。</li>
<li>当远程客户端需要调用客户端的 listener 中的方法时，被调用的方法也运行在 Binder 客户端的线程池中。同样不可以在服务端的 UI 线程调用客户端的耗时方法。</li>
<li>如果要在客户端的 Binder 线程池的方法里访问 UI，必须使用 Handler 切换到 UI 线程。</li>
</ul>
<h4 id="RemoteCallbackList"><a href="#RemoteCallbackList" class="headerlink" title="RemoteCallbackList"></a>RemoteCallbackList</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteCallbackList</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">IInterface</span>&gt;</span></div></pre></td></tr></table></figure>
<p>系统专门提供的用于删除跨进程 Listener 的类。支持任意的 AIDL 类型。  </p>
<p>内部有一个 <code>ArrayMap&lt;IBinder, Callback&gt;</code> 来保存所有的 AIDL 回调。</p>
<p>虽然多进程时服务端会生成一个不同的对象，但是他们对应的底层的 Binder 是同一个。只需要根据 Binder 查找对应的 listener 删除。  </p>
<p>当客户端进程终止后，它可以自动移除客户端所注册的 listener。  </p>
<p>内部自动实现了线程同步的功能。各个方法都加了 synchronized 锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mListenerList.beginBroadcast();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    IOnNewBookArrivedListener l = mListenerList.getBroadcastItem(i);          </div><div class="line">        <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//TODO handle l </span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">mListenerList.finishBroadcast();</div></pre></td></tr></table></figure>
<p><code>beginBroadcast</code>和<code>finishBroadcast</code>必须配对使用，哪怕只是想获取里面的元素数量。</p>
<h4 id="Binder-意外死亡"><a href="#Binder-意外死亡" class="headerlink" title="Binder 意外死亡"></a>Binder 意外死亡</h4><p>服务端意外停止，需要重新连接服务。</p>
<ol>
<li>给 Binder 设置 DeathRecipient 监听，Binder 死亡时会收到 binderDied() 回调，此方法在 Binder 线程池中被调用，不能访问 UI</li>
<li>在 ServiceConnection 中 onServiceDisconnected() 方法重连，此方法在 UI 线程中调用，可以访问 UI。</li>
</ol>
<h4 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h4><ol>
<li>在 onBind() 中验证。例如使用 permission 验证。</li>
<li>在服务端的 onTransact 方法进行验证，验证失败直接返回 false。<br>可以采用 permission，Uid 和 Pid</li>
</ol>
<h4 id="例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。"><a href="#例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。" class="headerlink" title="例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。"></a>例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。</h4><p>Book.aidl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IBook.aidl</span></div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="comment">//import me.luwenjie.myapplication.Book;</span></div><div class="line"></div><div class="line">parcelable Book;</div></pre></td></tr></table></figure>
<p>IBookListener.aidl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IOnNewBookArrivedListener.aidl</span></div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="keyword">import</span> me.luwenjie.myapplication.Book;</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookListener</span> </span>&#123;</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onAddBook</span><span class="params">(in Book book)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>IBookManager.aidl<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IBookManager.aidl</span></div><div class="line"><span class="keyword">package</span> me.luwenjie.myapplication;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="keyword">import</span> me.luwenjie.myapplication.Book;</div><div class="line"><span class="keyword">import</span> me.luwenjie.myapplication.IBookListener;</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> </span>&#123;</div><div class="line">  <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(in Book book)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(IBookListener listener)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(IBookListener listener)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BookManagerService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookManagerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BookManagerService"</span>;</div><div class="line">  <span class="keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBooks = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">  <span class="keyword">private</span> RemoteCallbackList&lt;IBookListener&gt; mBookListeners = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</div><div class="line">  <span class="keyword">private</span> AtomicBoolean mIsServiceDestoryed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Binder mBinder = <span class="keyword">new</span> IBookManager.Stub() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">      <span class="keyword">return</span> mBooks;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">      mBooks.add(book);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(IBookListener listener)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">      mBookListeners.register(listener);</div><div class="line">      <span class="comment">//if (!mBookListeners.contains(listener)) &#123;</span></div><div class="line">      <span class="comment">//  mBookListeners.add(listener);</span></div><div class="line">      <span class="comment">//&#125; else &#123;</span></div><div class="line">      <span class="comment">//  Log.d(TAG, listener + "already exits");</span></div><div class="line">      <span class="comment">//&#125;</span></div><div class="line">      Log.d(TAG, <span class="string">"listeners.size =  "</span> + getListenerSize());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(IBookListener listener)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">      mBookListeners.unregister(listener);</div><div class="line"></div><div class="line">      <span class="comment">//if (mBookListeners.contains(listener)) &#123;</span></div><div class="line">      <span class="comment">//  mBookListeners.remove(listener);</span></div><div class="line">      <span class="comment">//&#125; else &#123;</span></div><div class="line">      <span class="comment">//  Log.d(TAG, listener + "，not exits");</span></div><div class="line">      <span class="comment">//&#125;</span></div><div class="line">      Log.d(TAG, <span class="string">"listeners.size =  "</span> + getListenerSize());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></div><div class="line">        <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">      <span class="comment">// 验证 permission</span></div><div class="line">      <span class="keyword">int</span> i = checkCallingOrSelfPermission(<span class="string">"me.luwenjie.permission.BOOKMANAGER"</span>);</div><div class="line">      <span class="keyword">if</span> (i == PackageManager.PERMISSION_DENIED) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"PERMISSION_DENIED：me.luwenjie.permission.BOOKMANAGER"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 验证包名</span></div><div class="line">      String packageName;</div><div class="line">      String[] packages = getPackageManager().getPackagesForUid(getCallingUid());</div><div class="line">      <span class="keyword">if</span> (packages != <span class="keyword">null</span> &amp;&amp; packages.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        packageName = packages[<span class="number">0</span>];</div><div class="line">        <span class="keyword">if</span> (!packageName.startsWith(<span class="string">"me.luwenjie"</span>)) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getListenerSize</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = mBookListeners.beginBroadcast();</div><div class="line">    mBookListeners.finishBroadcast();</div><div class="line">    <span class="keyword">return</span> i;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = checkCallingOrSelfPermission(<span class="string">"me.luwenjie.permission.BOOKMANAGER"</span>);</div><div class="line">    <span class="keyword">if</span> (i == PackageManager.PERMISSION_DENIED) &#123;</div><div class="line">      Log.d(TAG, <span class="string">"PERMISSION_DENIED：me.luwenjie.permission.BOOKMANAGER"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    Log.d(TAG, <span class="string">"PERMISSION_GRANTED"</span>);</div><div class="line">    <span class="keyword">return</span> mBinder;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    mBooks.add(<span class="keyword">new</span> Book(<span class="string">"think in java"</span>, <span class="string">"48.90"</span>));</div><div class="line">    mBooks.add(<span class="keyword">new</span> Book(<span class="string">"Android开发艺术探索"</span>, <span class="string">"78.90"</span>));</div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> ServiceWorker()).start();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 避免直接在 UI 线程调用客户端的耗时方法，防止服务端无响应</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAddBook</span><span class="params">(Book book)</span> </span>&#123;</div><div class="line">    mBooks.add(book);</div><div class="line">    <span class="keyword">int</span> size = mBookListeners.beginBroadcast();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">      IBookListener item = mBookListeners.getBroadcastItem(i);</div><div class="line">      <span class="keyword">if</span> (item != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          item.onAddBook(book);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    mBookListeners.finishBroadcast();</div><div class="line">    <span class="comment">//for (IBookListener listener : mBookListeners) &#123;</span></div><div class="line">    <span class="comment">//  try &#123;</span></div><div class="line">    <span class="comment">//    listener.onAddBook(book);</span></div><div class="line">    <span class="comment">//  &#125; catch (RemoteException e) &#123;</span></div><div class="line">    <span class="comment">//    e.printStackTrace();</span></div><div class="line">    <span class="comment">//  &#125;</span></div><div class="line">    <span class="comment">//&#125;</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    mIsServiceDestoryed.set(<span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">while</span> (!mIsServiceDestoryed.get()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          Thread.sleep(<span class="number">5000</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> bookId = mBooks.size() + <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> price = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</div><div class="line">        Book newBook = <span class="keyword">new</span> Book(<span class="string">"newBook#"</span> + bookId, price + <span class="string">""</span>);</div><div class="line">        onAddBook(newBook);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BookManagerActivity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookManagerActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BookManagerActivity"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_NEW_BOOK_ADD = <span class="number">1</span>;</div><div class="line">  <span class="keyword">private</span> IBookManager mRemoteManager;</div><div class="line">  <span class="keyword">private</span> WeakHandler mHandler = <span class="keyword">new</span> WeakHandler(<span class="keyword">this</span>);</div><div class="line">  <span class="keyword">private</span> IBookListener mBookListener = <span class="keyword">new</span> IBookListener.Stub() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAddBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">      Message message = mHandler.obtainMessage(MESSAGE_NEW_BOOK_ADD, book);</div><div class="line">      message.sendToTarget();</div><div class="line"></div><div class="line">      <span class="comment">// 如果要在客户端的 Binder 线程池的方法里访问 UI，必须使用 Handler 切换到 UI 线程。</span></div><div class="line">      <span class="comment">// mHandler.post()</span></div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">      mRemoteManager = IBookManager.Stub.asInterface(service);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        mRemoteManager.registerListener(mBookListener);</div><div class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_bookmanager);</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, BookManagerService.class);</div><div class="line">    bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line"></div><div class="line">    findViewById(R.id.bt_add).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="comment">// 在子线程去调用远程服务端的耗时方法</span></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">int</span> price = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</div><div class="line">              <span class="keyword">int</span> name = mRemoteManager.getBookList().size() + <span class="number">1</span>;</div><div class="line">              addABook(<span class="string">"new Book#"</span> + name, <span class="string">""</span> + price);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">              e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;).start();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addABook</span><span class="params">(String name, String price)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Book&gt; list = mRemoteManager.getBookList();</div><div class="line">      Log.d(TAG, <span class="string">"query book list,list type:"</span> + list.getClass().getCanonicalName());</div><div class="line">      Log.d(TAG, <span class="string">"query book list:"</span> + list.toString());</div><div class="line">      <span class="keyword">for</span> (Book book : list) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"book info: "</span> + book.getName() + <span class="string">", "</span> + book.getPrice());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 添加一本书</span></div><div class="line">      <span class="keyword">final</span> Book newBook = <span class="keyword">new</span> Book(name, price);</div><div class="line">      mRemoteManager.addBook(newBook);</div><div class="line"></div><div class="line">      List&lt;Book&gt; newBookList = mRemoteManager.getBookList();</div><div class="line">      Log.i(TAG, <span class="string">"query book list:"</span> + newBookList.toString());</div><div class="line">      <span class="keyword">for</span> (Book book : newBookList) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"newBook info: "</span> + book.getName() + <span class="string">", "</span> + book.getPrice());</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    unbindService(mConnection);</div><div class="line"></div><div class="line">    <span class="comment">// 反注册监听器，这里会发现不起作用。后台找不到注册过的这个监听器，</span></div><div class="line">    <span class="comment">// 这里的监听器是从前台传到后台的，难道中间发生了变化？</span></div><div class="line">    <span class="comment">// 因为这是多进程，操作的不是同一个对象，Binder 会把客户端传过来的对象</span></div><div class="line">    <span class="comment">// 重新转化并生成一个新的对象。对象是不能跨进程传输的，本质上是通过序列化反序列化来完成。</span></div><div class="line">    <span class="comment">// 所以 AIDL 中的自定义对象都需要实现 Parcelable。</span></div><div class="line">    <span class="comment">// 必须使用 RemoteCallbackList 来解决这个问题。</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mRemoteManager != <span class="keyword">null</span> &amp;&amp; mRemoteManager.asBinder().isBinderAlive()) &#123;</div><div class="line">      Log.d(TAG, <span class="string">"unregister listener:"</span> + mBookListener);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        mRemoteManager.unregisterListener(mBookListener);</div><div class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;BookManagerActivity&gt; mActivity;</div><div class="line"></div><div class="line">    WeakHandler(BookManagerActivity activity) &#123;</div><div class="line">      mActivity = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">      BookManagerActivity activity = mActivity.get();</div><div class="line">      <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">          <span class="keyword">case</span> MESSAGE_NEW_BOOK_ADD:</div><div class="line">            Log.d(TAG, <span class="string">"receive new book :"</span> + msg.obj);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="使用-ContentProvider"><a href="#使用-ContentProvider" class="headerlink" title="使用 ContentProvider"></a>使用 ContentProvider</h3><p>用于不同应用共享数据，天生适合进程间通信。  </p>
<p>与 Messenger 一样，底层实现也是 Binder。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(<span class="string">"content://me.luwenjie.BookContentProvider"</span>);</div><div class="line">getContentResolver().query(uri,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</div><div class="line">getContentResolver().query(uri,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</div><div class="line">getContentResolver().query(uri,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>调用 3 次 query，onCreate 在主线程执行，三次 query 在 Binder 线程池的 3 个不同的线程执行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">onCreate, main</div><div class="line">query, Binder:<span class="number">6895_2</span></div><div class="line">query, Binder:<span class="number">6895_3</span></div><div class="line">query, Binder:<span class="number">6895_2</span></div></pre></td></tr></table></figure></p>
<h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4><p>BookContentProvider<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line">**</div><div class="line"> * created by venjer on <span class="number">23</span>/<span class="number">06</span>/<span class="number">2017</span> <span class="number">18</span>:<span class="number">52</span></div><div class="line"> * 除了(onCreate()) 方法都运行在 ContentProvider 的进程中</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookContentProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"me.luwenjie.BookContentProvider"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri BOOK_CONTENT_URI = Uri.parse(<span class="string">"content://"</span> + AUTHORITY + <span class="string">"/book"</span>);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri USER_CONTENT_URI = Uri.parse(<span class="string">"content://"</span> + AUTHORITY + <span class="string">"/user"</span>);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOOK_URI_CODE = <span class="number">0</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USER_URI_CODE = <span class="number">1</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher sUriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BookContentProvider"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">    <span class="comment">// 分别为 book 表和 user 表指定了 Uri。</span></div><div class="line">    sUriMatcher.addURI(AUTHORITY, <span class="string">"book"</span>, BOOK_URI_CODE);</div><div class="line">    sUriMatcher.addURI(AUTHORITY, <span class="string">"user"</span>, USER_URI_CODE);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> ContentResolver mContentResolver;</div><div class="line">  <span class="keyword">private</span> SQLiteDatabase mDb;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 由系统回调运行在主线程中</div><div class="line">   */</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"onCreate, "</span> + Thread.currentThread().getName());</div><div class="line"></div><div class="line">    initProviderData();</div><div class="line">    mContentResolver = getContext().getContentResolver();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initProviderData</span><span class="params">()</span> </span>&#123;</div><div class="line">    mDb = <span class="keyword">new</span> DbOpenHelper(getContext()).getWritableDatabase();</div><div class="line">    mDb.execSQL(<span class="string">"delete from "</span> + DbOpenHelper.BOOK_TABLE_NAME);</div><div class="line">    mDb.execSQL(<span class="string">"delete from "</span> + DbOpenHelper.USER_TABLE_NAME);</div><div class="line">    mDb.execSQL(<span class="string">"insert into book values(3,'Android');"</span>);</div><div class="line">    mDb.execSQL(<span class="string">"insert into book values(4,'iOS');"</span>);</div><div class="line">    mDb.execSQL(<span class="string">"insert into book values(5,'Html5');"</span>);</div><div class="line">    mDb.execSQL(<span class="string">"insert into user values(1,'jake',1);"</span>);</div><div class="line">    mDb.execSQL(<span class="string">"insert into user values(2,'jasmine',0);"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(@NonNull Uri uri)</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"getType, "</span> + Thread.currentThread().getName());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(@NonNull Uri uri, @Nullable String[] projection, @Nullable String selection,</span></span></div><div class="line">      @Nullable String[] selectionArgs, @Nullable String sortOrder) &#123;</div><div class="line">    Log.d(TAG, <span class="string">"query, "</span> + Thread.currentThread().getName());</div><div class="line">    String tableName = getTableName(uri);</div><div class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(tableName)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported URI: "</span> + uri);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> mDb.query(tableName, projection, selection, selectionArgs, <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values)</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"insert, "</span> + Thread.currentThread().getName());</div><div class="line">    String tableName = getTableName(uri);</div><div class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(tableName)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported URI: "</span> + uri);</div><div class="line">    &#125;</div><div class="line">    mDb.insert(tableName, <span class="keyword">null</span>, values);</div><div class="line">    <span class="keyword">if</span> (mContentResolver != <span class="keyword">null</span>) mContentResolver.notifyChange(uri, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">return</span> uri;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(@NonNull Uri uri, @Nullable String selection,</span></span></div><div class="line">      @Nullable String[] selectionArgs) &#123;</div><div class="line">    Log.d(TAG, <span class="string">"delete, "</span> + Thread.currentThread().getName());</div><div class="line">    String table = getTableName(uri);</div><div class="line">    <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported URI: "</span> + uri);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> raw = mDb.delete(table, selection, selectionArgs);</div><div class="line">    <span class="keyword">if</span> (raw &gt; <span class="number">0</span> &amp;&amp; mContentResolver != <span class="keyword">null</span>) mContentResolver.notifyChange(uri, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">return</span> raw;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values, @Nullable String selection,</span></span></div><div class="line">      @Nullable String[] selectionArgs) &#123;</div><div class="line">    Log.d(TAG, <span class="string">"update, "</span> + Thread.currentThread().getName());</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 通过uri获取表名</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getTableName</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">    String tableName = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">switch</span> (sUriMatcher.match(uri)) &#123;</div><div class="line">      <span class="keyword">case</span> BOOK_URI_CODE:</div><div class="line">        tableName = DbOpenHelper.BOOK_TABLE_NAME;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> USER_URI_CODE:</div><div class="line">        tableName = DbOpenHelper.USER_TABLE_NAME;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> tableName;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DbOpenHelper<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbOpenHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_TABLE_NAME = <span class="string">"book"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TABLE_NAME = <span class="string">"user"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"DbOpenHelper"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_NAME = <span class="string">"book_provider.db"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB_VERSION = <span class="number">1</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 图书和用户信息表</span></div><div class="line">  <span class="keyword">private</span> String CREATE_BOOK_TABLE =</div><div class="line">      <span class="string">"CREATE TABLE IF NOT EXISTS "</span> + BOOK_TABLE_NAME + <span class="string">"(_ID INTEGER PRIMARY KEY,"</span> + <span class="string">"name TEXT)"</span>;</div><div class="line">  <span class="keyword">private</span> String CREATE_USER_TABLE = <span class="string">"CREATE TABLE IF NOT EXISTS "</span></div><div class="line">      + USER_TABLE_NAME</div><div class="line">      + <span class="string">"(_ID INTEGER PRIMARY KEY,"</span></div><div class="line">      + <span class="string">"name TEXT,"</span></div><div class="line">      + <span class="string">"sex INT)"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DbOpenHelper</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, DB_NAME, <span class="keyword">null</span>, DB_VERSION);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DbOpenHelper</span><span class="params">(Context context, String name, SQLiteDatabase.CursorFactory factory,</span></span></div><div class="line">      <span class="keyword">int</span> version) &#123;</div><div class="line">    <span class="keyword">super</span>(context, name, factory, version);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DbOpenHelper</span><span class="params">(Context context, String name, SQLiteDatabase.CursorFactory factory,</span></span></div><div class="line">      <span class="keyword">int</span> version, DatabaseErrorHandler errorHandler) &#123;</div><div class="line">    <span class="keyword">super</span>(context, name, factory, version, errorHandler);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</div><div class="line">    db.execSQL(CREATE_USER_TABLE);</div><div class="line">    db.execSQL(CREATE_BOOK_TABLE);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ContentProviderActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentProviderActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ContentProviderActivity"</span>;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_contentprovider);</div><div class="line">    <span class="comment">//Uri uri = Uri.parse("content://me.luwenjie.BookContentProvider");</span></div><div class="line">    <span class="comment">//getContentResolver().query(uri,null,null,null,null);</span></div><div class="line">    <span class="comment">//getContentResolver().query(uri,null,null,null,null);</span></div><div class="line">    <span class="comment">//getContentResolver().query(uri,null,null,null,null);</span></div><div class="line">    Uri bookUri = Uri.parse(<span class="string">"content://me.luwenjie.BookContentProvider/book"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 先添加一本 程序设计的艺术</span></div><div class="line">    ContentValues values = <span class="keyword">new</span> ContentValues();</div><div class="line">    values.put(<span class="string">"_id"</span>, <span class="number">6</span>);</div><div class="line">    values.put(<span class="string">"name"</span>, <span class="string">"程序设计的艺术"</span>);</div><div class="line">    getContentResolver().insert(bookUri, values);</div><div class="line"></div><div class="line">    <span class="comment">// 查询所有的书</span></div><div class="line">    Cursor bookCursor =</div><div class="line">        getContentResolver().query(bookUri, <span class="keyword">new</span> String[] &#123; <span class="string">"_id"</span>, <span class="string">"name"</span> &#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">if</span> (bookCursor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">while</span> (bookCursor.moveToNext()) &#123;</div><div class="line">        Book book = <span class="keyword">new</span> Book();</div><div class="line">        book.setBookId(bookCursor.getInt(<span class="number">0</span>));</div><div class="line">        book.setName(bookCursor.getString(<span class="number">1</span>));</div><div class="line">        Log.d(TAG, <span class="string">"query book: "</span> + book.toString());</div><div class="line">      &#125;</div><div class="line">      bookCursor.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Uri userUri = Uri.parse(<span class="string">"content://me.luwenjie.BookContentProvider/user"</span>);</div><div class="line"></div><div class="line">    Cursor userCursor =</div><div class="line">        getContentResolver().query(userUri, <span class="keyword">new</span> String[] &#123; <span class="string">"_id"</span>, <span class="string">"name"</span>, <span class="string">"sex"</span> &#125;, <span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">            <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">if</span> (userCursor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">while</span> (userCursor.moveToNext()) &#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setUserId(userCursor.getInt(<span class="number">0</span>));</div><div class="line">        user.setUserName(userCursor.getString(<span class="number">1</span>));</div><div class="line">        user.setMale(userCursor.getInt(<span class="number">2</span>) == <span class="number">1</span>);</div><div class="line">        Log.d(TAG, <span class="string">"query user: "</span> + user.toString());</div><div class="line">      &#125;</div><div class="line">      userCursor.close();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AndroidManifest.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">provider</span></span></div><div class="line">       <span class="attr">android:name</span>=<span class="string">".BookContentProvider"</span></div><div class="line">       <span class="attr">android:authorities</span>=<span class="string">"me.luwenjie.BookContentProvider"</span></div><div class="line">       <span class="attr">android:permission</span>=<span class="string">"me.luwenjie.BOOK_PROVIDER"</span></div><div class="line">       <span class="attr">android:process</span>=<span class="string">":provider"</span></div><div class="line">       /&gt;</div></pre></td></tr></table></figure></p>
<h3 id="使用-Socket"><a href="#使用-Socket" class="headerlink" title="使用 Socket"></a>使用 Socket</h3><p>套接字，分为流式套接字和用户数据报套接字。<br>对应于网络的传输控制层的 TCP 和 UDP 协议。TCP 协议是面向连接的协议，提供稳定的双向通信功能。<br>UDP 是无连接的，提供不稳定的单向通信功能，也可实现双向通信。  </p>
<p>UDP 拥有更好的效率，但是不保证数据的正确传输。</p>
<h2 id="Binder-连接池"><a href="#Binder-连接池" class="headerlink" title="Binder 连接池"></a>Binder 连接池</h2><p>当有非常多的业务模块都需要使用 AIDL 时，不能无限制的增加 Service 的数量。应该将所有的 AIDL 放在同一个 Service 中去管理。</p>
<p>每个业务模块创建自己的 AIDL 接口并实现此接口，不同的业务模块不能有耦合，向服务端提供自己的唯一标识和其对应的 Binder 对象。</p>
<p><img src="https://cdn.cnbj1.fds.api.mi-img.com/book/images/33fcd0776ee12b29e43bd819cf825f79" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BindPool</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_SECURITY_CENTER = <span class="number">1</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_COMPUTE = <span class="number">2</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BindPool"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> BindPool sInstance;</div><div class="line">  <span class="keyword">private</span> IBindPool mIBinderPool;</div><div class="line">  <span class="keyword">private</span> CountDownLatch mCountDownLatch;</div><div class="line">  <span class="keyword">private</span> Context mContext;</div><div class="line">  <span class="keyword">private</span> IBinder.DeathRecipient mDeathRecipient = <span class="keyword">new</span> IBinder.DeathRecipient() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</div><div class="line">      Log.d(TAG, <span class="string">"binder died"</span>);</div><div class="line">      mIBinderPool.asBinder().unlinkToDeath(mDeathRecipient, <span class="number">0</span>);</div><div class="line">      mIBinderPool = <span class="keyword">null</span>;</div><div class="line">      connectBinderPoolService();</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  <span class="keyword">private</span> ServiceConnection mBinderPoolConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">      mIBinderPool = IBindPool.Stub.asInterface(service);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        mIBinderPool.asBinder().linkToDeath(mDeathRecipient, <span class="number">0</span>);</div><div class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">      mCountDownLatch.countDown();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BindPool</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    mContext = context.getApplicationContext();</div><div class="line">    connectBinderPoolService();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BindPool <span class="title">getInstance</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (BindPool.class) &#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">          sInstance = <span class="keyword">new</span> BindPool(context);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connectBinderPoolService</span><span class="params">()</span> </span>&#123;</div><div class="line">    mCountDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    Intent service = <span class="keyword">new</span> Intent(mContext, BinderPoolService.class);</div><div class="line">    mContext.bindService(service, mBinderPoolConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      mCountDownLatch.await();</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> bindCode)</span> </span>&#123;</div><div class="line">    IBinder binder = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (mIBinderPool != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        binder = mIBinderPool.queryBinder(bindCode);</div><div class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> binder;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolImpl</span> <span class="keyword">extends</span> <span class="title">IBindPool</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BinderPoolImpl"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span> </span>&#123;</div><div class="line">      IBinder iBinder = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">switch</span> (binderCode) &#123;</div><div class="line">        <span class="keyword">case</span> BINDER_SECURITY_CENTER:</div><div class="line">          iBinder = <span class="keyword">new</span> SecurityCenterImpl();</div><div class="line">          <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> BINDER_COMPUTE:</div><div class="line">          iBinder = <span class="keyword">new</span> ComputeImpl();</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> iBinder;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="选用合适的-IPC"><a href="#选用合适的-IPC" class="headerlink" title="选用合适的 IPC"></a>选用合适的 IPC</h2><p><img src="https://cdn.cnbj1.fds.api.mi-img.com/book/images/fa1eb34bd7621f9d36bc75e5a2386970" alt=""></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android开发艺术探索/">Android开发艺术探索</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/20/androidArt5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Android开发艺术探索笔记-第5章 RemoteViews
        
      </div>
    </a>
  
  
    <a href="/2017/06/19/Android开发艺术探索笔记第6章/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Android开发艺术探索笔记-第6章 Android的Drawable</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#多进程"><span class="nav-number">1.1.</span> <span class="nav-text">多进程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-中的多进程模式"><span class="nav-number">2.</span> <span class="nav-text">Android 中的多进程模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#开启多进程"><span class="nav-number">2.1.</span> <span class="nav-text">开启多进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行机制"><span class="nav-number">2.2.</span> <span class="nav-text">运行机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例子"><span class="nav-number">2.2.1.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原因"><span class="nav-number">2.2.2.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用多进程造成的问题"><span class="nav-number">2.2.3.</span> <span class="nav-text">使用多进程造成的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统提供跨进程方式解决"><span class="nav-number">2.2.4.</span> <span class="nav-text">系统提供跨进程方式解决</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IPC-基础概念"><span class="nav-number">3.</span> <span class="nav-text">IPC 基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Serializable-接口"><span class="nav-number">3.1.</span> <span class="nav-text">Serializable 接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例子-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serialVersionUID-的工作机制"><span class="nav-number">3.1.2.</span> <span class="nav-text">serialVersionUID 的工作机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意"><span class="nav-number">3.1.3.</span> <span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parcelable-接口"><span class="nav-number">3.2.</span> <span class="nav-text">Parcelable 接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parcel"><span class="nav-number">3.3.</span> <span class="nav-text">Parcel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#区别"><span class="nav-number">3.4.</span> <span class="nav-text">区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Binder"><span class="nav-number">4.</span> <span class="nav-text">Binder</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AIDL-的例子"><span class="nav-number">4.1.</span> <span class="nav-text">AIDL 的例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Binder-的工作机制"><span class="nav-number">4.2.</span> <span class="nav-text">Binder 的工作机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#手动实现-Binder"><span class="nav-number">4.3.</span> <span class="nav-text">手动实现 Binder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkToDeath-和-unlinkToDeath"><span class="nav-number">4.4.</span> <span class="nav-text">linkToDeath 和 unlinkToDeath</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-中的-IPC-方式"><span class="nav-number">4.5.</span> <span class="nav-text">Android 中的 IPC 方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bundle"><span class="nav-number">4.5.1.</span> <span class="nav-text">Bundle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用文件共享"><span class="nav-number">4.5.2.</span> <span class="nav-text">使用文件共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Messenger"><span class="nav-number">4.5.3.</span> <span class="nav-text">使用 Messenger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-AIDL"><span class="nav-number">4.5.4.</span> <span class="nav-text">使用 AIDL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RemoteCallbackList"><span class="nav-number">4.5.4.1.</span> <span class="nav-text">RemoteCallbackList</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder-意外死亡"><span class="nav-number">4.5.4.2.</span> <span class="nav-text">Binder 意外死亡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#权限"><span class="nav-number">4.5.4.3.</span> <span class="nav-text">权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。"><span class="nav-number">4.5.4.4.</span> <span class="nav-text">例子：图书管理类，每隔5s后台加一本书并通知前台加了什么书。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-ContentProvider"><span class="nav-number">4.5.5.</span> <span class="nav-text">使用 ContentProvider</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子-2"><span class="nav-number">4.5.5.1.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Socket"><span class="nav-number">4.5.6.</span> <span class="nav-text">使用 Socket</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Binder-连接池"><span class="nav-number">4.6.</span> <span class="nav-text">Binder 连接池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#选用合适的-IPC"><span class="nav-number">4.7.</span> <span class="nav-text">选用合适的 IPC</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2017 luwenjie&#39;s Blog All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            luwenjie&#39;s Blog
          </div>
          <div class="panel-body">
            Copyright © 2017 luwenjie All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>