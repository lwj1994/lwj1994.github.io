<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="学习笔记," />










<meta name="description" content="上篇自定义 View 笔记 2 - MeasureSpec 详解分析了MeasureSpec生成的原理，父容器测量子 View首先确定MeasureSpec，再让子View测量自己。">
<meta name="keywords" content="学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="自定义 View 笔记 3 - onMeasure() 的过程">
<meta property="og:url" content="https://luwenjie.me/2017/01/19/自定义 View onMeasure() 的过程/index.html">
<meta property="og:site_name" content="逃避可耻但很有用">
<meta property="og:description" content="上篇自定义 View 笔记 2 - MeasureSpec 详解分析了MeasureSpec生成的原理，父容器测量子 View首先确定MeasureSpec，再让子View测量自己。">
<meta property="og:image" content="http://7xt4re.com1.z0.glb.clouddn.com/2017012440753Jietu20170124-155630.jpg?imageView/2/w/300/q/100">
<meta property="og:image" content="http://cuntuku.com/images/2017/01/19/Jietu20170119-222605.jpg">
<meta property="og:image" content="http://cuntuku.com/images/2017/01/17/QQ20170117-2140552x.png">
<meta property="og:updated_time" content="2017-01-29T10:13:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自定义 View 笔记 3 - onMeasure() 的过程">
<meta name="twitter:description" content="上篇自定义 View 笔记 2 - MeasureSpec 详解分析了MeasureSpec生成的原理，父容器测量子 View首先确定MeasureSpec，再让子View测量自己。">
<meta name="twitter:image" content="http://7xt4re.com1.z0.glb.clouddn.com/2017012440753Jietu20170124-155630.jpg?imageView/2/w/300/q/100">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://luwenjie.me/2017/01/19/自定义 View onMeasure() 的过程/"/>





  <title>自定义 View 笔记 3 - onMeasure() 的过程 | 逃避可耻但很有用</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逃避可耻但很有用</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://luwenjie.me/2017/01/19/自定义 View onMeasure() 的过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fromzero">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逃避可耻但很有用">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">自定义 View 笔记 3 - onMeasure() 的过程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-19T22:23:00+08:00">
                2017-01-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义-View/" itemprop="url" rel="index">
                    <span itemprop="name">自定义 View</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>上篇<a href="https://luwenjie.me/2017/01/19/%E8%87%AA%E5%AE%9A%E4%B9%89%20View%20%E7%AC%94%E8%AE%B0%20-%20MeasureSpec%20%E8%AF%A6%E8%A7%A3/">自定义 View 笔记 2 - MeasureSpec 详解</a>分析了MeasureSpec生成的原理，父容器测量子 View首先确定MeasureSpec，再让子View测量自己。<br><a id="more"></a></p>
<p>完整的流程图是这样的：</p>
<p><img src="http://7xt4re.com1.z0.glb.clouddn.com/2017012440753Jietu20170124-155630.jpg?imageView/2/w/300/q/100" alt=""></p>
<p>父类和子类共同确定完子类的MeassureSpec后，子类就要测量自身的尺寸。</p>
<p>其中子View测量自身源码的调用流程图：<br><img src="http://cuntuku.com/images/2017/01/19/Jietu20170119-222605.jpg" alt="子View OnMeasure() 的过程"><br>我们从尾到头看一下源码的实现。</p>
<h2 id="View-getSuggestedMinimumWidth-amp-View-getSuggestedMinimumHeight"><a href="#View-getSuggestedMinimumWidth-amp-View-getSuggestedMinimumHeight" class="headerlink" title="View#getSuggestedMinimumWidth() &amp; View#getSuggestedMinimumHeight()"></a>View#getSuggestedMinimumWidth() &amp; View#getSuggestedMinimumHeight()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回视图的最小宽度。先比较视图的最小值和背景的最小值，返回较小的。</div><div class="line"> * <span class="doctag">@return</span> 建议的视图最小宽度</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回视图的最小高度。先比较视图的最小值和背景的最小值，返回较小的。</div><div class="line"> * <span class="doctag">@return</span> 建议的视图最小高度</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinHeight : max(mMinHeight, mBackground.getMinimumHeight());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="View-getDefaultSize-int-int-："><a href="#View-getDefaultSize-int-int-：" class="headerlink" title="View#getDefaultSize(int, int)："></a>View#getDefaultSize(int, int)：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回一个默认的大小。如果 MeasureSpec 没有约束，则使用提供的大小。</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size View 的默认大小</div><div class="line"> * <span class="doctag">@param</span> measureSpec 此视图的 MeasureSpec</div><div class="line"> * <span class="doctag">@return</span> View 应该得到的默认大小</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> result = size;</div><div class="line">  <span class="comment">// 获得此视图的测量模式</span></div><div class="line">  <span class="keyword">int</span> specMode = View.MeasureSpec.getMode(measureSpec);</div><div class="line">  <span class="comment">// 获得此时图的测量大小</span></div><div class="line">  <span class="keyword">int</span> specSize = View.MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">    <span class="comment">// 如果未限制，结果为 View 的默认大小</span></div><div class="line">    <span class="keyword">case</span> View.MeasureSpec.UNSPECIFIED:</div><div class="line">      result = size;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="comment">// 如果限制为准确模式或最大模式，结果为 MeasureSpec 的测量大小</span></div><div class="line">    <span class="keyword">case</span> View.MeasureSpec.AT_MOST:</div><div class="line">    <span class="keyword">case</span> View.MeasureSpec.EXACTLY:</div><div class="line">      result = specSize;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="View-setMeasuredDimension-int-int"><a href="#View-setMeasuredDimension-int-int" class="headerlink" title="View#setMeasuredDimension(int, int)"></a>View#setMeasuredDimension(int, int)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 这个方法必须由 onMeasure(int, int) 调用来存储测量宽度和测量高度。如果没有调用会触发测量时异常。</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth 此视图的测量宽度</div><div class="line"> * <span class="doctag">@param</span> measuredHeight 此视图的测量高度</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">  <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">  <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">    Insets insets = getOpticalInsets();</div><div class="line">    <span class="keyword">int</span> opticalWidth = insets.left + insets.right;</div><div class="line">    <span class="keyword">int</span> opticalHeight = insets.top + insets.bottom;</div><div class="line"></div><div class="line">    measuredWidth += optical ? opticalWidth : -opticalWidth;</div><div class="line">    measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">  &#125;</div><div class="line">  setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述方法最终调用 View#setMeasuredDimensionRaw(int, int)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 原始的设置测量的尺寸。</div><div class="line"> * <span class="doctag">@param</span> measuredWidth</div><div class="line"> * <span class="doctag">@param</span> measuredHeight</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">  <span class="comment">// 赋值</span></div><div class="line">  mMeasuredWidth = measuredWidth;</div><div class="line">  mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">  <span class="comment">// 设置 flag</span></div><div class="line">  mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="View-onMeasure-int-int"><a href="#View-onMeasure-int-int" class="headerlink" title="View#onMeasure(int, int)"></a>View#onMeasure(int, int)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 测量视图及其内容以确定测量的宽度和测量的高度。 此方法由 measure（int，int）调用，应由子类覆盖以提供其内容的准确和高效的测量。</div><div class="line"> *</div><div class="line"> * 当覆写这个方法的时候，必须调用 setMeasuredDimension(int, int) 存储视图的测量宽度和高度。否则会被 measure() 抛出 IllegalStateException。</div><div class="line"> *</div><div class="line"> * 可以直接调用父类的 onMeasure(int, int)</div><div class="line"> *</div><div class="line"> * 除非 MeasureSpec 允许更大的尺寸，测量的基本类实现默认是背景的大小。子类应该重写 onMeasure(int, int)，提供更好的内容测量。</div><div class="line"> *</div><div class="line"> * 如果这个方法被覆盖，子类必须保证测量的高度和宽度不小于视图的最小高度和宽度。</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec 此 View 的宽的 MeasureSpec</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec 此 View 的高的 MeasureSpec</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">  setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">      getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="为什么自定义View设置为WRAP-CONTENT，最后显示的效果是MATCH-PARENT"><a href="#为什么自定义View设置为WRAP-CONTENT，最后显示的效果是MATCH-PARENT" class="headerlink" title="为什么自定义View设置为WRAP_CONTENT，最后显示的效果是MATCH_PARENT?"></a>为什么自定义View设置为<code>WRAP_CONTENT</code>，最后显示的效果是<code>MATCH_PARENT</code>?</h2><p>根据上篇总结的MeasureSpec生成的规则表可以得知，如果子View的布局参数是<code>WRAP_CONTENT</code>，不管父容器的MeasureSpec模式是<code>EXACTLY</code>还是<code>AT_MOST</code>，子View的MeasureSpec模式都是<code>AT_MOST</code>，且大小都为父容器剩下的大小。</p>
<p><a href="http://img.blog.csdn.net/20160510112048981" target="_blank" rel="external"><img src="http://cuntuku.com/images/2017/01/17/QQ20170117-2140552x.png" alt=""></a></p>
<p>所以我们虽然设置了<code>WRAP_CONTENT</code>，最后看到的效果却是<code>MATCH_PARENT</code>。</p>
<h3 id="如何fix这个问题？"><a href="#如何fix这个问题？" class="headerlink" title="如何fix这个问题？"></a>如何fix这个问题？</h3><p>我们通过重写<code>onMeasure()</code>处理宽或高为<code>WRAP_CONTENT</code>的情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">  <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">  <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">  <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line"></div><div class="line">  <span class="comment">// 如果宽和高都是AT_MOST模式，宽和高都设置为默认值，否则宽或高另设默认值</span></div><div class="line">  <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST &amp;&amp; heightMode == MeasureSpec.AT_MOST) &#123;</div><div class="line">    setMeasuredDimension(mWidth, mHeight);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthMode == MeasureSpec.AT_MOST) &#123;</div><div class="line">    setMeasuredDimension(mWidth, heightSize);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</div><div class="line">    setMeasuredDimension(widthSize, mHeight);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="子View布局为MATCH-PARENT，父容器的模式为AT-MOST的情况"><a href="#子View布局为MATCH-PARENT，父容器的模式为AT-MOST的情况" class="headerlink" title="子View布局为MATCH_PARENT，父容器的模式为AT_MOST的情况"></a>子View布局为<code>MATCH_PARENT</code>，父容器的模式为<code>AT_MOST</code>的情况</h2><p>对照上面的MeasureSpec生成规则图，有这种情况：如果子View布局参数为<code>MATCH_PARENT</code>，父容器的模式为<code>AT_MOST</code>，那么子View的MeasureSpec模式为<code>AT_MOST</code>，大小为父容器剩下的大小。</p>
<p>如果这种情况下我们也根据判断是否为<code>AT_MOST</code>模式进行默认值赋值。那么子View的大小结果就是一个准确的值，而它的模式却是<code>MATCH_PARENT</code>。</p>
<p>这种情况是不合理的：  </p>
<ol>
<li><p>不可能出现根View的大小为wrap_content但它的一个子View大小为match_parent。</p>
</li>
<li><p>从根到这个子View的父容器都是wrap_content，而子View的大小为match_parent。这个极端情况也是不会的。</p>
</li>
<li><p>从根到这个子View的父容器都是wrap_content，而子View大小也为wrap_content。这是个正常情况也正是我们改良后的onMeasure()来专门处理的子View大小为wrap_content的情况。  </p>
</li>
</ol>
<h2 id="LinearLayout的测量过程"><a href="#LinearLayout的测量过程" class="headerlink" title="LinearLayout的测量过程"></a>LinearLayout的测量过程</h2><p><code>public abstract class ViewGroup extends View implements ViewParent, ViewManager</code>  </p>
<p>ViewGroup是一个抽象类，它没有重写View的<code>onMeasure()</code>。容器类继承ViewGroup并根据自身的情况重写<code>onMeasure()</code>。</p>
<h3 id="父容器类如何测量子View并且确定自身的大小？"><a href="#父容器类如何测量子View并且确定自身的大小？" class="headerlink" title="父容器类如何测量子View并且确定自身的大小？"></a>父容器类如何测量子View并且确定自身的大小？</h3><p>我们看看LinearLayout是如何做的。</p>
<h4 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure()"></a>onMeasure()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</div><div class="line">        measureVertical(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        measureHorizontal(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="measureVertical"><a href="#measureVertical" class="headerlink" title="measureVertical()"></a>measureVertical()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">measureVertical</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    mTotalLength = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> alternativeMaxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> weightedMaxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> allFillParent = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">float</span> totalWeight = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthMode = View.MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightMode = View.MeasureSpec.getMode(heightMeasureSpec);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> matchWidth = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> skippedMeasure = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> baselineChildIndex = mBaselineAlignedChildIndex;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useLargestChild = mUseLargestChild;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> largestChildHeight = Integer.MIN_VALUE;</div><div class="line">    <span class="keyword">int</span> consumedExcessSpace = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 遍历得到每个孩子的高度，并记录最大宽度。</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">      <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">      <span class="comment">// 若孩子为空，跳出本次循环</span></div><div class="line">      <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">        mTotalLength += measureNullChild(i);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 孩子的显示状态为GONE</span></div><div class="line">      <span class="keyword">if</span> (child.getVisibility() == GONE) &#123;</div><div class="line">        i += getChildrenSkipCount(child, i);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 判断是否有分割线</span></div><div class="line">      <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</div><div class="line">        mTotalLength += mDividerHeight;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 得到孩子的LayoutParams</span></div><div class="line">      <span class="keyword">final</span> LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">      <span class="comment">// weight累加到总weight上</span></div><div class="line">      totalWeight += lp.weight;</div><div class="line"></div><div class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> useExcessSpace = lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>;</div><div class="line">      <span class="keyword">if</span> (heightMode == View.MeasureSpec.EXACTLY &amp;&amp; useExcessSpace) &#123;</div><div class="line">        <span class="comment">// Optimization: don't bother measuring children who are only</span></div><div class="line">        <span class="comment">// laid out using excess space. These views will get measured</span></div><div class="line">        <span class="comment">// later if we have space to distribute.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + lp.topMargin + lp.bottomMargin);</div><div class="line">        skippedMeasure = <span class="keyword">true</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (useExcessSpace) &#123;</div><div class="line">          <span class="comment">// The heightMode is either UNSPECIFIED or AT_MOST, and</span></div><div class="line">          <span class="comment">// this child is only laid out using excess space. Measure</span></div><div class="line">          <span class="comment">// using WRAP_CONTENT so that we can find out the view's</span></div><div class="line">          <span class="comment">// optimal height. We'll restore the original height of 0</span></div><div class="line">          <span class="comment">// after measurement.</span></div><div class="line">          lp.height = LinearLayout.LayoutParams.WRAP_CONTENT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Determine how big this child would like to be. If this or</span></div><div class="line">        <span class="comment">// previous children have given a weight, then we allow it to</span></div><div class="line">        <span class="comment">// use all available space (and we will shrink things later</span></div><div class="line">        <span class="comment">// if needed).</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> usedHeight = totalWeight == <span class="number">0</span> ? mTotalLength : <span class="number">0</span>;</div><div class="line">        measureChildBeforeLayout(child, i, widthMeasureSpec, <span class="number">0</span>,</div><div class="line">            heightMeasureSpec, usedHeight);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">        <span class="keyword">if</span> (useExcessSpace) &#123;</div><div class="line">          <span class="comment">// Restore the original height and record how much space</span></div><div class="line">          <span class="comment">// we've allocated to excess-only children so that we can</span></div><div class="line">          <span class="comment">// match the behavior of EXACTLY measurement.</span></div><div class="line">          lp.height = <span class="number">0</span>;</div><div class="line">          consumedExcessSpace += childHeight;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + childHeight + lp.topMargin +</div><div class="line">            lp.bottomMargin + getNextLocationOffset(child));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (useLargestChild) &#123;</div><div class="line">          largestChildHeight = Math.max(childHeight, largestChildHeight);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * If applicable, compute the additional offset to the child's baseline</div><div class="line">       * we'll need later when asked &#123;<span class="doctag">@link</span> #getBaseline&#125;.</div><div class="line">       */</div><div class="line">      <span class="keyword">if</span> ((baselineChildIndex &gt;= <span class="number">0</span>) &amp;&amp; (baselineChildIndex == i + <span class="number">1</span>)) &#123;</div><div class="line">        mBaselineChildTop = mTotalLength;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// if we are trying to use a child index for our baseline, the above</span></div><div class="line">      <span class="comment">// book keeping only works if there are no children above it with</span></div><div class="line">      <span class="comment">// weight.  fail fast to aid the developer.</span></div><div class="line">      <span class="keyword">if</span> (i &lt; baselineChildIndex &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"A child of LinearLayout with index "</span></div><div class="line">            + <span class="string">"less than mBaselineAlignedChildIndex has weight &gt; 0, which "</span></div><div class="line">            + <span class="string">"won't work.  Either remove the weight, or don't set "</span></div><div class="line">            + <span class="string">"mBaselineAlignedChildIndex."</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> matchWidthLocally = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">if</span> (widthMode != View.MeasureSpec.EXACTLY &amp;&amp; lp.width == LinearLayout.LayoutParams.MATCH_PARENT) &#123;</div><div class="line">        <span class="comment">// The width of the linear layout will scale, and at least one</span></div><div class="line">        <span class="comment">// child said it wanted to match our width. Set a flag</span></div><div class="line">        <span class="comment">// indicating that we need to remeasure at least that view when</span></div><div class="line">        <span class="comment">// we know our width.</span></div><div class="line">        matchWidth = <span class="keyword">true</span>;</div><div class="line">        matchWidthLocally = <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> margin = lp.leftMargin + lp.rightMargin;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line">      maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line">      childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line"></div><div class="line">      allFillParent = allFillParent &amp;&amp; lp.width == LinearLayout.LayoutParams.MATCH_PARENT;</div><div class="line">      <span class="keyword">if</span> (lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Widths of weighted Views are bogus if we end up</div><div class="line">                 * remeasuring, so keep them separate.</div><div class="line">                 */</div><div class="line">        weightedMaxWidth = Math.max(weightedMaxWidth,</div><div class="line">            matchWidthLocally ? margin : measuredWidth);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">            matchWidthLocally ? margin : measuredWidth);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      i += getChildrenSkipCount(child, i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mTotalLength &gt; <span class="number">0</span> &amp;&amp; hasDividerBeforeChildAt(count)) &#123;</div><div class="line">      mTotalLength += mDividerHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (useLargestChild &amp;&amp;</div><div class="line">        (heightMode == View.MeasureSpec.AT_MOST || heightMode == View.MeasureSpec.UNSPECIFIED)) &#123;</div><div class="line">      mTotalLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">          mTotalLength += measureNullChild(i);</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child.getVisibility() == GONE) &#123;</div><div class="line">          i += getChildrenSkipCount(child, i);</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams)</div><div class="line">            child.getLayoutParams();</div><div class="line">        <span class="comment">// Account for negative margins</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + largestChildHeight +</div><div class="line">            lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add in our padding</span></div><div class="line">    mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> heightSize = mTotalLength;</div><div class="line"></div><div class="line">    <span class="comment">// Check against our minimum height</span></div><div class="line">    heightSize = Math.max(heightSize, getSuggestedMinimumHeight());</div><div class="line"></div><div class="line">    <span class="comment">// Reconcile our calculated size with the heightMeasureSpec</span></div><div class="line">    <span class="keyword">int</span> heightSizeAndState = resolveSizeAndState(heightSize, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">    heightSize = heightSizeAndState &amp; MEASURED_SIZE_MASK;</div><div class="line"></div><div class="line">    <span class="comment">// Either expand children with weight to take up available space or</span></div><div class="line">    <span class="comment">// shrink them if they extend beyond our current bounds. If we skipped</span></div><div class="line">    <span class="comment">// measurement on any children, we need to measure them now.</span></div><div class="line">    <span class="keyword">int</span> remainingExcess = heightSize - mTotalLength</div><div class="line">        + (mAllowInconsistentMeasurement ? <span class="number">0</span> : consumedExcessSpace);</div><div class="line">    <span class="keyword">if</span> (skippedMeasure || remainingExcess != <span class="number">0</span> &amp;&amp; totalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">      <span class="keyword">float</span> remainingWeightSum = mWeightSum &gt; <span class="number">0.0f</span> ? mWeightSum : totalWeight;</div><div class="line"></div><div class="line">      mTotalLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.getVisibility() == GONE) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> childWeight = lp.weight;</div><div class="line">        <span class="keyword">if</span> (childWeight &gt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> share = (<span class="keyword">int</span>) (childWeight * remainingExcess / remainingWeightSum);</div><div class="line">          remainingExcess -= share;</div><div class="line">          remainingWeightSum -= childWeight;</div><div class="line"></div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> childHeight;</div><div class="line">          <span class="keyword">if</span> (mUseLargestChild &amp;&amp; heightMode != View.MeasureSpec.EXACTLY) &#123;</div><div class="line">            childHeight = largestChildHeight;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lp.height == <span class="number">0</span> &amp;&amp; (!mAllowInconsistentMeasurement</div><div class="line">              || heightMode == View.MeasureSpec.EXACTLY)) &#123;</div><div class="line">            <span class="comment">// This child needs to be laid out from scratch using</span></div><div class="line">            <span class="comment">// only its share of excess space.</span></div><div class="line">            childHeight = share;</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// This child had some intrinsic height to which we</span></div><div class="line">            <span class="comment">// need to add its share of excess space.</span></div><div class="line">            childHeight = child.getMeasuredHeight() + share;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = View.MeasureSpec.makeMeasureSpec(</div><div class="line">              Math.max(<span class="number">0</span>, childHeight), View.MeasureSpec.EXACTLY);</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">              mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin,</div><div class="line">              lp.width);</div><div class="line">          child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">          <span class="comment">// Child may now not fit in vertical dimension.</span></div><div class="line">          childState = combineMeasuredStates(childState, child.getMeasuredState()</div><div class="line">              &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> margin =  lp.leftMargin + lp.rightMargin;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line">        maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> matchWidthLocally = widthMode != View.MeasureSpec.EXACTLY &amp;&amp;</div><div class="line">            lp.width == LinearLayout.LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">        alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">            matchWidthLocally ? margin : measuredWidth);</div><div class="line"></div><div class="line">        allFillParent = allFillParent &amp;&amp; lp.width == LinearLayout.LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + child.getMeasuredHeight() +</div><div class="line">            lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Add in our padding</span></div><div class="line">      mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line">      <span class="comment">// <span class="doctag">TODO:</span> Should we recompute the heightSpec based on the new total length?</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">          weightedMaxWidth);</div><div class="line"></div><div class="line"></div><div class="line">      <span class="comment">// We have no limit, so make all weighted views as tall as the largest child.</span></div><div class="line">      <span class="comment">// Children will have already been measured once.</span></div><div class="line">      <span class="keyword">if</span> (useLargestChild &amp;&amp; heightMode != View.MeasureSpec.EXACTLY) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">          <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">          <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.getVisibility() == GONE) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">final</span> LinearLayout.LayoutParams lp =</div><div class="line">              (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">          <span class="keyword">float</span> childExtra = lp.weight;</div><div class="line">          <span class="keyword">if</span> (childExtra &gt; <span class="number">0</span>) &#123;</div><div class="line">            child.measure(</div><div class="line">                View.MeasureSpec.makeMeasureSpec(child.getMeasuredWidth(),</div><div class="line">                    View.MeasureSpec.EXACTLY),</div><div class="line">                View.MeasureSpec.makeMeasureSpec(largestChildHeight,</div><div class="line">                    View.MeasureSpec.EXACTLY));</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!allFillParent &amp;&amp; widthMode != View.MeasureSpec.EXACTLY) &#123;</div><div class="line">      maxWidth = alternativeMaxWidth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    maxWidth += mPaddingLeft + mPaddingRight;</div><div class="line"></div><div class="line">    <span class="comment">// Check against our minimum width</span></div><div class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">        heightSizeAndState);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (matchWidth) &#123;</div><div class="line">      forceUniformWidth(count, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这段代码的主要操作：</p>
<ol>
<li>遍历每个子View，并对每个子View调用measureChildBeforeLayout()，请参见代码第115-133行<br>在measureChildBeforeLayout()方法内又会调用measureChildWithMargins()从而测量每个子View的大小。在该过程中mTotalLength保存了LinearLayout的高度，所以每当测量完一个子View该值都会发生变化。</li>
<li>调用setMeasuredDimension()设置LinearLayout的大小。</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/学习笔记/" rel="tag"># 学习笔记</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/19/自定义 View 笔记 - MeasureSpec 详解/" rel="next" title="自定义 View 笔记 2 - MeasureSpec 详解">
                <i class="fa fa-chevron-left"></i> 自定义 View 笔记 2 - MeasureSpec 详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/25/Android中的groovy及Gradle/" rel="prev" title="Android中的groovy及gradle">
                Android中的groovy及gradle <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">fromzero</p>
              <p class="site-description motion-element" itemprop="description">fix myself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#View-getSuggestedMinimumWidth-amp-View-getSuggestedMinimumHeight"><span class="nav-number">1.</span> <span class="nav-text">View#getSuggestedMinimumWidth() & View#getSuggestedMinimumHeight()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-getDefaultSize-int-int-："><span class="nav-number">2.</span> <span class="nav-text">View#getDefaultSize(int, int)：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-setMeasuredDimension-int-int"><span class="nav-number">3.</span> <span class="nav-text">View#setMeasuredDimension(int, int)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-onMeasure-int-int"><span class="nav-number">4.</span> <span class="nav-text">View#onMeasure(int, int)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么自定义View设置为WRAP-CONTENT，最后显示的效果是MATCH-PARENT"><span class="nav-number">5.</span> <span class="nav-text">为什么自定义View设置为WRAP_CONTENT，最后显示的效果是MATCH_PARENT?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何fix这个问题？"><span class="nav-number">5.1.</span> <span class="nav-text">如何fix这个问题？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子View布局为MATCH-PARENT，父容器的模式为AT-MOST的情况"><span class="nav-number">6.</span> <span class="nav-text">子View布局为MATCH_PARENT，父容器的模式为AT_MOST的情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LinearLayout的测量过程"><span class="nav-number">7.</span> <span class="nav-text">LinearLayout的测量过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#父容器类如何测量子View并且确定自身的大小？"><span class="nav-number">7.1.</span> <span class="nav-text">父容器类如何测量子View并且确定自身的大小？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#onMeasure"><span class="nav-number">7.1.1.</span> <span class="nav-text">onMeasure()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#measureVertical"><span class="nav-number">7.1.2.</span> <span class="nav-text">measureVertical()</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fromzero</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
